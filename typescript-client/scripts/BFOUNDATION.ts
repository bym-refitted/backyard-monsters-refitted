import {
    Bitmap,
    BitmapData,
    BlendMode,
    DisplayObject,
    MovieClip,
    Sprite,
    Event,
    MouseEvent,
    ColorMatrixFilter,
    Matrix,
    Point,
    Rectangle
} from "openfl";

// Assumed imports for custom classes
import { SecNum } from "./com/cc/utils/SecNum";
import { GameObject } from "./com/monsters/GameObject";
import { BYMConfig } from "./com/monsters/configs/BYMConfig";
import { BYMDevConfig } from "./com/monsters/configs/BYMDevConfig";
import { Console } from "./com/monsters/debug/Console";
import { BuildingAssetContainer } from "./com/monsters/display/BuildingAssetContainer";
import { BuildingOverlay } from "./com/monsters/display/BuildingOverlay";
import { ImageCache } from "./com/monsters/display/ImageCache";
import { Fire } from "./com/monsters/effects/fire/Fire";
import { Smoke } from "./com/monsters/effects/smoke/Smoke";
import { EnumYardType } from "./com/monsters/enums/EnumYardType";
import { BuildingEvent } from "./com/monsters/events/BuildingEvent";
import { ICoreBuilding } from "./com/monsters/interfaces/ICoreBuilding";
import { ITargetable } from "./com/monsters/interfaces/ITargetable";
import { InventoryManager } from "./com/monsters/inventory/InventoryManager";
import { InstanceManager } from "./com/monsters/managers/InstanceManager";
import { MapRoomManager } from "./com/monsters/maproom_manager/MapRoomManager";
import { MonsterBase } from "./com/monsters/monsters/MonsterBase";
import { CModifiableProperty } from "./com/monsters/monsters/components/CModifiableProperty";
import { PATHING } from "./com/monsters/pathing/PATHING";
import { RasterData } from "./com/monsters/rendering/RasterData";
import { ImageCallbackHelper } from "./com/monsters/utils/ImageCallbackHelper";
import { MovieClipUtils } from "./com/monsters/utils/MovieClipUtils";

// Global singletons (Assumed to be available)
import { BASE, GLOBAL, MAP, KEYS, ATTACK, SOUNDS, UI2, QUEUE, POPUPS, UPDATES, LOGGER, STORE, TUTORIAL, QUESTS, GRID, HOUSING, BUILDINGS, BTOTEM, MONSTERBUNKER, BUILDINGOPTIONS, PLANNER, LOGIN, ResourcePackages } from "./GlobalImports";

// Assumed Asset Imports (These would be generated by OpenFL from the SWF/Assets)
// For the sake of compilation, we assume these are globally available or imported * as Assets
declare const window: any; // Fallback for dynamic class lookup

export class BFOUNDATION extends GameObject {
    public static readonly TICK_LIMIT: number = 1209600;

    private static s_totalBuildingHP: number;
    private static s_totalBuildingMaxHP: number;

    public static readonly _IMAGE_NAMES: Array<string> = ["shadow", "", "top", "anim", "anim2", "anim3"];

    public static readonly _RASTERDATA_SHADOW: number = 0;
    public static readonly _RASTERDATA_FOOTPRINT: number = 1;
    public static readonly _RASTERDATA_TOP: number = 2;
    public static readonly _RASTERDATA_ANIM: number = 3;
    public static readonly _RASTERDATA_ANIM2: number = 4;
    public static readonly _RASTERDATA_ANIM3: number = 5;
    public static readonly _RASTERDATA_FORTFRONT: number = 6;
    public static readonly _RASTERDATA_FORTBACK: number = 7;
    public static readonly _RASTERDATA_AMOUNT: number = 8;

    public static readonly k_STATE_DESTROYED: string = "destroyed";
    public static readonly k_STATE_DAMAGED: string = "damaged";
    public static readonly k_STATE_DEFAULT: string = "";

    public _mcBase: MovieClip | BuildingAssetContainer;
    public _mcFootprint: MovieClip;
    public _mcHit: MovieClip;
    public topContainer: BuildingAssetContainer;
    public animContainer: BuildingAssetContainer;
    public _fortBackContainer: BuildingAssetContainer;
    public _fortFrontContainer: BuildingAssetContainer;
    public _spriteAlert: Sprite;
    public _mcAlert: DisplayObject;
    public _position: Point;
    public _oldPosition: Point;
    public _stopMoveCount: number;
    public _moving: boolean;
    public _mouseOffset: Point;
    public _footprint: Array<any>;
    public _blockers: Array<any>;
    public _gridCost: Array<any>;
    public _clickTimer: number;
    public _prefab: number = 0;
    public _buildInstant: boolean = false;
    public _buildInstantCost: SecNum;
    public _fortification: SecNum;
    public readonly _nullPoint: Point = new Point(0, 0);

    public _animLoaded: boolean = false;
    public _animBMD: BitmapData;
    public _animRect: Rectangle;
    public _animContainerBMD: BitmapData;
    public _animTick: number = 0;
    public _animFrames: number = 0;

    public anim2Container: BuildingAssetContainer;
    public _anim2BMD: BitmapData;
    public _anim2ContainerBMD: BitmapData;
    public _anim2Rect: Rectangle;
    public _anim2Frames: number = 0;
    public _anim2Tick: number = 0;
    public _anim2Loaded: boolean = false;

    public anim3Container: BuildingAssetContainer;
    public _anim3BMD: BitmapData;
    public _anim3ContainerBMD: BitmapData;
    public _anim3Rect: Rectangle;
    public _anim3Frames: number = 0;
    public _anim3Tick: number = 0;
    public _anim3Loaded: boolean = false;

    public _animRandomStart: boolean = true;

    public _countdownBuild: SecNum;
    public _countdownUpgrade: SecNum;
    public _countdownRebuild: SecNum;
    public _countdownProduce: SecNum;
    public _countdownFortify: SecNum;
    public _stored: SecNum;
    public _lvl: SecNum;

    public _threadid: number;
    public _subject: string;
    public _senderid: number;
    public _senderName: string;
    public _senderPic: string;

    public _hpCountdownRebuild: number;
    public _hpCountdownProduce: number;
    public _hpStored: number;
    public _hpLvl: number;
    public _repairing: number;
    public _repairTime: number;
    public _productionStage: SecNum;

    public _looted: boolean = false;
    public _hasWorker: boolean;
    public _hasResources: boolean;
    public _counter: number;
    public _type: number;
    public _attackgroup: number;
    public _class: string;
    public _id: number;
    public _energy: number;
    public _fired: boolean;
    public _creatures: Array<any>;

    public _buildingTitle: string;
    public _buildingInstructions: string;
    public _buildingStats: string;
    public _buildingDescription: string;
    public _upgradeDescription: string;
    public _recycleDescription: string;
    public _specialDescription: string;
    public _repairDescription: string;
    public _blockRecycle: boolean;
    public _upgradeCosts: string;
    public _recycleCosts: string;
    public _buildingProps: any;
    public _resource: number;
    public _range: number;
    public _rate: number;
    public _splash: number;
    public _speed: number;
    public _producing: number;
    public _constructed: boolean;
    public _placing: boolean;
    public _oldY: number;
    public _upgrading: string;
    public _origin: Point;
    public _shake: number;
    public _picking: boolean;
    public _monsterQueue: Array<any>;
    public _inProduction: string;
    public _taken: SecNum;
    public _spoutPoint: Point;
    public _spoutHeight: number;
    public _canFunction: boolean;
    public _helpList: Array<any>;
    public _destroyed: boolean = false;

    public _renderState: string = null;
    public _oldRenderState: string = null;
    public _lastLoadedState: string = null;
    public _renderLevel: number = 0;
    public _renderFortLevel: number = 0;

    public _treat: number;
    public _expireTime: number = 0;

    protected imageData: any;
    private _lastBarIndex: number = -1;
    public _overlayOffset: Point;

    protected _rasterData: Array<RasterData>;
    protected _rasterPt: Array<Point>;
    protected _offsets: Array<Point>;
    protected _sources: Array<DisplayObject>;

    protected _debugRasterData: RasterData;

    protected m_bmd: BitmapData;
    protected m_shadowBMD: BitmapData;
    protected m_footprintBMD: BitmapData;
    protected m_hitBMD: BitmapData;
    protected m_bmHit: Bitmap;
    protected m_hitOffsetIndex: number;

    protected _imageCallbackHelpers: Array<ImageCallbackHelper>;

    public _recycled: boolean = false;
    public damageProperty: CModifiableProperty;

    private _mouseClicked: boolean;

    constructor() {
        super();
        this._overlayOffset = new Point(0, 0);
        this._spoutPoint = new Point(1, -67);
        this._spoutHeight = 135;
        this.setHealth(1);
        this._energy = 0;
        this._buildingTitle = "";
        this._buildingDescription = "";
        this._buildingInstructions = "";
        this._upgradeDescription = "";
        this._buildingStats = "";
        this._creatures = [];
        this._helpList = [];

        this._rasterData = new Array<RasterData>(BFOUNDATION._RASTERDATA_AMOUNT);
        this._rasterPt = new Array<Point>(BFOUNDATION._RASTERDATA_AMOUNT);
        this._offsets = new Array<Point>(BFOUNDATION._RASTERDATA_AMOUNT);
        this._sources = new Array<DisplayObject>(BFOUNDATION._RASTERDATA_AMOUNT);

        for (let i = this._rasterPt.length - 1; i >= 0; i--) {
            this._rasterPt[i] = new Point();
            this._offsets[i] = new Point();
        }

        this._imageCallbackHelpers = new Array<ImageCallbackHelper>();

        this._fortification = new SecNum(0);
        this._countdownBuild = new SecNum(0);
        this._countdownRebuild = new SecNum(0);
        this._countdownUpgrade = new SecNum(0);
        this._countdownProduce = new SecNum(0);
        this._countdownFortify = new SecNum(0);
        this._stored = new SecNum(0);
        this._lvl = new SecNum(0);
        this._hpCountdownRebuild = 0;
        this._hpCountdownProduce = 0;
        this._hpStored = 0;
        this._hpLvl = 0;
        this._inProduction = "";
        this._productionStage = new SecNum(0);
        this._constructed = false;
        this._placing = true;
        this._repairing = 0;
        this._mouseOffset = new Point(0, 0);
        this._oldY = 0;

        if (BASE.isOutpostOrInfernoOutpost) {
            this._blockRecycle = true;
        }

        InstanceManager.addInstance(this);
        this.damageProperty = new CModifiableProperty();
        this.graphic.addEventListener(Event.REMOVED_FROM_STAGE, this.removedFromStage);
    }

    public static get totalBuildingHP(): number {
        return BFOUNDATION.s_totalBuildingHP;
    }

    public static get totalBuildingMaxHP(): number {
        return BFOUNDATION.s_totalBuildingMaxHP;
    }

    public static updateAllRasterData(): void {
        if (!BYMConfig.instance.RENDERER_ON) {
            return;
        }
        let instances = InstanceManager.getInstancesByClass(BFOUNDATION);
        for (let b of instances) {
            (b as BFOUNDATION).updateRasterData();
        }
    }

    public static redrawAllShadowData(): void {
        let instances = InstanceManager.getInstancesByClass(BFOUNDATION);
        // Method was empty in AS3 except for variable declaration
    }

    private static sortByDepth(param1: any, param2: any): number {
        if (!(param1 as BFOUNDATION).rasterPt[BFOUNDATION._RASTERDATA_SHADOW]) {
            return 1;
        }
        if (!(param2 as BFOUNDATION).rasterPt[BFOUNDATION._RASTERDATA_SHADOW]) {
            return -1;
        }
        return (param1 as BFOUNDATION).rasterPt[BFOUNDATION._RASTERDATA_SHADOW].y - (param2 as BFOUNDATION).rasterPt[BFOUNDATION._RASTERDATA_SHADOW].y;
    }

    public static getBuildingSaveData(): Array<any> {
        let exportBuildingData: any = null;
        let buildingData: BFOUNDATION = null;
        let hasTownHall: boolean = false;
        let saveData: Array<any> = new Array<any>();
        let building: Array<any> = InstanceManager.getInstancesByClass(BFOUNDATION);
        let buildingHealthData: any = {};
        let buildingDataByID: any = {};
        let hashString: string = "";

        saveData[0] = buildingDataByID;
        saveData[1] = buildingHealthData;
        BFOUNDATION.s_totalBuildingHP = BFOUNDATION.s_totalBuildingMaxHP = 0;

        for (let obj of building) {
            buildingData = obj as BFOUNDATION;
            // Note: Assuming BMUSHROOM is checked via class name or instanceof
            if (buildingData.constructor.name !== "BMUSHROOM" && !(GLOBAL._newBuilding === buildingData)) {
                if ((buildingData as any as ICoreBuilding)) {
                    hasTownHall = true;
                }

                if ((buildingData.constructor.name === "BTRAP" && buildingData._fired) || (buildingData._type == 53 && buildingData._expireTime < GLOBAL.Timestamp())) {
                    Console.warning("Ignored Building" + buildingData + buildingData._type + buildingData._expireTime + " setting buildinghealthdata to 0");
                    buildingHealthData[buildingData._id] = 0;
                } else {
                    if (buildingData.constructor.name !== "BWALL") {
                        if (BASE.isMainYardOrInfernoMainYard && (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD || GLOBAL.mode == GLOBAL.e_BASE_MODE.IBUILD)) {
                            BFOUNDATION.s_totalBuildingHP += buildingData.maxHealth;
                        } else {
                            BFOUNDATION.s_totalBuildingHP += buildingData.health;
                        }
                        BFOUNDATION.s_totalBuildingMaxHP += buildingData.maxHealth;
                    }
                    if (buildingData.health < buildingData.maxHealth) {
                        buildingHealthData[buildingData._id] = Math.floor(buildingData.health);
                    }
                    if ((exportBuildingData = buildingData.Export())) {
                        buildingDataByID[buildingData._id] = exportBuildingData;
                        hashString += (exportBuildingData.X + exportBuildingData.Y).toString();
                    }
                }
            }
        }

        if (!hasTownHall) {
            LOGGER.Log("err", "User missing TownHall upon save");
            Console.warning("BFOUNDATION::getBuildingSaveData(TownHall missing upon save)");
        }

        BASE._percentDamaged = 100 - 100 / BFOUNDATION.s_totalBuildingMaxHP * BFOUNDATION.s_totalBuildingHP;
        
        // Fix: Removed md5 call as noted in prompt
        // saveData[2] = md5(hashString);
        saveData[2] = hashString;
        return saveData;
    }

    public override get width(): number {
        return this._mcHit.width;
    }

    public override get height(): number {
        return this._mcHit.height;
    }

    public get rasterPt(): Array<Point> {
        return this._rasterPt;
    }

    public get damage(): number {
        return this.damageProperty.value;
    }

    public get isDamaged(): boolean {
        return this.health < this.maxHealth;
    }

    public get isCriticallyDamaged(): boolean {
        return this.health < this.maxHealth * 0.5;
    }

    public override modifyHealth(amount: number, source: ITargetable = null): number {
        let lootMult: number;
        let lootedAmount: number;

        if (!this.isTargetable) {
            Console.warning("you are trying to deal damage to a building that isn't targetable.... why you doin that bro?");
            return 0;
        }

        let originalDamage: number = amount;
        amount = Math.abs(amount);

        if (this._fortification.Get() > 0) {
            amount *= 100 - (this._fortification.Get() * 10 + 10);
            amount /= 100;
        }

        amount *= this.armor ? 1 - this.armor : 1;
        this.setHealth(this.health - amount);

        if (this.health <= 0) {
            this._repairing = 0;
            this.setHealth(0);
            if (!this._destroyed) {
                this.Destroyed(source != null);
            }
        } else if (this._class != "wall") {
            ATTACK.Log("b" + this._id, "<font color=\"#990000\">" + KEYS.Get("attack_log_%damaged", {
                "v1": this._lvl.Get(),
                "v2": KEYS.Get(this._buildingProps.name),
                "v3": 100 - Math.floor(100 / this.maxHealth * this.health)
            }) + "</font>");
        }

        if (source && !this._destroyed) {
            lootMult = 1;
            if (source instanceof MonsterBase) {
                lootMult = (source as MonsterBase).lootingMultiplier;
            }
            lootedAmount = this.Loot(amount * lootMult);
            ATTACK.damage(amount, this, amount - originalDamage);
        }

        if (GameObject.k_DOES_PRINT_DETAILED_LOGGING && GLOBAL._aiDesignMode) {
            amount = Math.round(amount);
            originalDamage = Math.round(originalDamage);
            console.log(this.name + " was hit for " + amount + (!!(originalDamage - amount) ? "(" + originalDamage + " - " + (originalDamage - amount) + ")" : "") + " damage(looted " + lootedAmount + "), left with " + this.health + " out of " + this.maxHealth + "hp");
        }

        this.Update();
        return amount;
    }

    public SetProps(): void {
        try {
            this._buildingProps = GLOBAL._buildingProps[this._type - 1];
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  buildingprops | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps buildingprops");
            return;
        }
        try {
            this._mcFootprint = BYMConfig.instance.RENDERER_ON ? this.GetFootprintMC() : MAP._BUILDINGFOOTPRINTS.addChild(this.GetFootprintMC()) as MovieClip;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mcfootprint 1 | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps mcfootprint1");
            return;
        }
        try {
            if (!BYMConfig.instance.RENDERER_ON) {
                this._mc = MAP._BUILDINGTOPS.addChild(new MovieClip()) as MovieClip;
            } else {
                this._mc = new MovieClip();
            }
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mc | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  mc");
            return;
        }
        try {
            this.topContainer = new BuildingAssetContainer();
            this.topContainer.mouseChildren = false;
            this.topContainer.mouseEnabled = false;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  topContainer | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  topContainer");
            return;
        }
        try {
            this.animContainer = new BuildingAssetContainer();
            this.animContainer.mouseChildren = false;
            this.animContainer.mouseEnabled = false;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  animContainer | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  animContainer");
            return;
        }
        try {
            this._fortFrontContainer = new BuildingAssetContainer();
            this._fortFrontContainer.mouseChildren = false;
            this._fortFrontContainer.mouseEnabled = false;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  _fortFrontContainer | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  _fortFrontContainer");
            return;
        }
        try {
            this._fortBackContainer = new BuildingAssetContainer();
            this._fortBackContainer.mouseChildren = false;
            this._fortBackContainer.mouseEnabled = false;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  _fortBackContainer | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  _fortBackContainer");
            return;
        }
        try {
            if (!BYMConfig.instance.RENDERER_ON) {
                this._mc.addChild(this._fortBackContainer);
                this._mc.addChild(this.topContainer);
                this._mc.addChild(this.animContainer);
                this._mc.addChild(this._fortFrontContainer);
            }
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mc.addChildren | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  mc.addChildren");
            return;
        }
        try {
            if (!BYMConfig.instance.RENDERER_ON) {
                this._mcBase = MAP._BUILDINGBASES.addChild(new BuildingAssetContainer()) as BuildingAssetContainer;
            } else {
                this._mcBase = new BuildingAssetContainer();
            }
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mcBase | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  mcBase");
            return;
        }
        try {
            this._mcHit = this.GetHitMC();
            this._mcHit.gotoAndStop(1);
            if (BYMConfig.instance.RENDERER_ON) {
                MAP._BUILDINGTOPS.addChild(this._mcHit);
            } else {
                this._mc.addChild(this._mcHit);
            }
            this._mcHit.cacheAsBitmap = true;
            this._mcHit.alpha = 0;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mcHit | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  mcHit");
            return;
        }
        try {
            (this as any)._size = this._buildingProps.size;
            this._class = this._buildingProps.type;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  size/class | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  size/class");
            return;
        }
        try {
            this._mcFootprint.gotoAndStop(1);
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  mcFootprint 2 | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  mcFootprint 2");
            return;
        }
        try {
            this._attackgroup = this._buildingProps.attackgroup;
            this._mouseOffset = new Point(0, Math.floor(this._mcFootprint.height / 20) * 10);
            (this as any)._middle = this._footprint[0].height * 0.5;
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.SetProps:  end stuff | " + e.message + " | " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.SetProps:  end");
            return;
        }

        this.anim2Container = new BuildingAssetContainer();
        this.anim2Container.mouseChildren = false;
        this.anim2Container.mouseEnabled = false;

        this.anim3Container = new BuildingAssetContainer();
        this.anim3Container.mouseChildren = false;
        this.anim3Container.mouseEnabled = false;

        if (!BYMConfig.instance.RENDERER_ON) {
            this._mc.addChild(this.anim2Container);
            this._mc.addChild(this.anim3Container);
        }

        if (this._buildingProps.isUntargetable) {
            this.targetableStatus = 1;
        }
        if (this._buildingProps.isImmobile) {
            this.moveSpeedProperty.value = 0;
        }
    }

    public Bank(): void {
    }

    public Description(): void {
        let percentDamaged: number;
        let costData: any;

        if (this._buildingProps.names != null && this._buildingProps.names.length >= this._lvl.Get()) {
            this._buildingTitle = "<b>" + this._buildingProps.names[this._lvl.Get() - 1] + "</b>";
        } else {
            this._buildingTitle = "<b>" + this._buildingProps.name + "</b>";
            if (this._buildingProps.costs.length > 1) {
                this._buildingTitle += " " + KEYS.Get("bdg_level", { "v1": this._lvl.Get() });
            }
        }

        if (this.health < this.maxHealth) {
            if (this._countdownUpgrade.Get() > 0) {
                this._repairDescription = "<font color=\"#FF0000\"><b>" + KEYS.Get("repaironhold_upgrade") + "</b></font>";
            } else if (this._countdownFortify.Get() > 0) {
                this._repairDescription = "<font color=\"#FF0000\"><b>" + KEYS.Get("repaironhold_fortify") + "</b></font>";
            } else {
                percentDamaged = 100 - Math.ceil(100 / this.maxHealth * this.health);
                this._specialDescription = "<font color=\"#FF0000\"><b>" + KEYS.Get("building_percentdamaged", { "v1": percentDamaged }) + "</b></font>";
            }
        } else {
            if (this._buildingProps.descriptions != null && this._buildingProps.descriptions.length >= this._lvl.Get()) {
                this._specialDescription = this._buildingProps.descriptions[this._lvl.Get() - 1];
            } else {
                this._specialDescription = this._buildingProps.description;
            }

            if (!(this._type == 24 || this._type == 25 || this._type == 26)) {
                if (this._type == 20 || this._type == 21) {
                    this._buildingStats = KEYS.Get("building_stats_dps", {
                        "v1": this._range,
                        "v2": this.damage,
                        "v3": Math.floor(this.damage * (40 / this._rate)),
                        "v4": this._splash,
                        "v5": Math.floor(40 / this._rate * 10) / 10
                    });

                    if (this._type == 20) {
                        this._buildingDescription = KEYS.Get("building_cannon_desc");
                    }
                    if (this._type == 21) {
                        this._buildingDescription = KEYS.Get("building_sniper_desc");
                    }
                    if (this._lvl.Get() < this._buildingProps.costs.length) {
                        this._upgradeDescription = KEYS.Get("building_stats", {
                            "v1": this._buildingProps.stats[this._lvl.Get()].range,
                            "v2": this._buildingProps.stats[this._lvl.Get()].damage,
                            "v3": this._buildingProps.stats[this._lvl.Get()].splash,
                            "v4": Math.floor(40 / this._buildingProps.stats[this._lvl.Get()].rate * 10) / 10
                        });
                    }
                }
            }
        }

        this._recycleDescription = "";
        if (this._repairing == 1) {
            this._repairDescription = "<font color=\"#FF0000\"><b>" + KEYS.Get("building_damagedinattack") + "</b></font><br>" + KEYS.Get("building_repairinprogress", {
                "v1": Math.floor(100 / this.maxHealth * this.health),
                "v2": GLOBAL.ToTime(this.getEstimatedRepairTimeRemaining())
            });
        } else {
            this._repairDescription = "<font color=\"#FF0000\"><b>" + KEYS.Get("building_damagedinattack") + "</b></font><br>" + KEYS.Get("building_repairfree");
            if (this._countdownBuild.Get() > 0) {
                this._repairDescription += "<br>" + KEYS.Get("building_attackdestroy");
            }
            if (this._countdownUpgrade.Get() > 0) {
                this._repairDescription += "<br>" + KEYS.Get("building_attacksetback");
            }
        }

        if (this._lvl.Get() >= this._buildingProps.costs.length) {
            this._upgradeDescription = KEYS.Get("bdg_fullyupgraded");
            this._upgradeCosts = "";
        } else {
            this._upgradeCosts = "";
            costData = this._buildingProps.costs[this._lvl.Get()];

            if (costData.r1.Get() > 0) {
                if (costData.r1.Get() > BASE._resources.r1.Get()) {
                    this._upgradeCosts += "<font color=\"#FF0000\">";
                }
                this._upgradeCosts += GLOBAL.FormatNumber(costData.r1.Get()) + " " + GLOBAL._resourceNames[0] + "</font> - ";
            }
            if (costData.r2.Get() > 0) {
                if (costData.r2.Get() > BASE._resources.r2.Get()) {
                    this._upgradeCosts += "<font color=\"#FF0000\">";
                }
                this._upgradeCosts += GLOBAL.FormatNumber(costData.r2.Get()) + " " + GLOBAL._resourceNames[1] + "</font> - ";
            }
            if (costData.r3.Get() > 0) {
                if (costData.r3.Get() > BASE._resources.r3.Get()) {
                    this._upgradeCosts += "<font color=\"#FF0000\">";
                }
                this._upgradeCosts += GLOBAL.FormatNumber(costData.r3.Get()) + " " + GLOBAL._resourceNames[2] + "</font> - ";
            }
            if (costData.r4.Get() > 0) {
                if (costData.r4.Get() > BASE._resources.r4.Get()) {
                    this._upgradeCosts += "<font color=\"#FF0000\">";
                }
                this._upgradeCosts += GLOBAL.FormatNumber(costData.r4.Get()) + " " + GLOBAL._resourceNames[3] + "</font> - ";
            }
            this._upgradeCosts += GLOBAL.ToTime(costData.time.Get());
            this._upgradeDescription = "";
        }
    }

    public getEstimatedRepairTimeRemaining(): number {
        let repairTime: number = 0;
        if (this._lvl.Get() == 0) {
            repairTime = Math.floor(this._buildingProps.repairTime[0]);
        } else {
            repairTime = Math.floor(this._buildingProps.repairTime[this._lvl.Get() - 1]);
        }
        repairTime = Math.min(3600, repairTime);
        repairTime = Math.ceil(this.maxHealth / repairTime);
        return Math.floor((this.maxHealth - this.health) / repairTime);
    }

    public RenderClear(fully: boolean = true): void {
        if (this.m_isCleared) {
            return;
        }
        if (fully) {
            this._renderState = null;
        }
        (this._mcBase as BuildingAssetContainer).Clear();
        this.topContainer.Clear();
        this.animContainer.Clear();
        this.anim2Container.Clear();
        this.anim3Container.Clear();
    }

    public Render(state: string = ""): void {
        let imageDataA: any = null;
        let imageDataB: any = null;
        let imageLevel: number = 0;
        let fortImageDataA: any = null;
        let fortImageDataB: any = null;
        let fortImageLevel: number = 0;
        let i: number = 0;
        let loadImages: Array<string> = null;
        let length: number = 0;
        let imageGroupYardType: number = 0;
        let j: number = 0;
        let loadFortImages: Array<string> = null;

        if (GLOBAL._catchup) {
            return;
        }

        if (this._renderState == null || state !== this._renderState || this._lvl.Get() != this._renderLevel) {
            this._renderLevel = this._lvl.Get();
            imageDataA = GLOBAL._buildingProps[this._type - 1].imageData;

            if (this._lvl.Get() == 0) {
                imageDataB = imageDataA[1];
                imageLevel = 1;
            } else if (imageDataA[this._lvl.Get()]) {
                imageDataB = imageDataA[this._lvl.Get()];
                imageLevel = this._lvl.Get();
            } else {
                i = this._lvl.Get() - 1;
                while (i > 0) {
                    if (imageDataA[i]) {
                        imageDataB = imageDataA[i];
                        imageLevel = i;
                        break;
                    }
                    i--;
                }
            }

            this._oldRenderState = this._renderState;
            this._renderState = state;

            if (imageDataB) {
                loadImages = [];
                if (!imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state]) {
                    state = "";
                }
                length = BFOUNDATION._IMAGE_NAMES.length;
                i = 0;
                while (i < length) {
                    if (imageDataB[BFOUNDATION._IMAGE_NAMES[i] + state]) {
                        loadImages.push(imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[i] + state][0]);
                    }
                    i++;
                }

                this._animLoaded = false;
                if (state === BFOUNDATION.k_STATE_DAMAGED || state === BFOUNDATION.k_STATE_DESTROYED) {
                    this._anim2Loaded = false;
                    this._anim3Loaded = true;
                } else {
                    this._anim2Loaded = false;
                    this._anim3Loaded = false;
                }

                // In AS3, arguments.callee was used. Here we bind and store the bound function reference
                // for identification in the callback.
                const boundCallback = this.ImageCallback.bind(this);
                this._imageCallbackHelpers.push(new ImageCallbackHelper(boundCallback, state, imageLevel, imageDataA, imageDataB));

                imageGroupYardType = BASE.yardType;
                switch (imageGroupYardType) {
                    case EnumYardType.PLAYER:
                        imageGroupYardType = Number(EnumYardType.MAIN_YARD);
                        break;
                    case EnumYardType.RESOURCE:
                    case EnumYardType.STRONGHOLD:
                    case EnumYardType.FORTIFICATION:
                        imageGroupYardType = Number(EnumYardType.OUTPOST);
                }
                ImageCache.GetImageGroupWithCallBack(imageGroupYardType + "b" + this._type + "-" + imageLevel + state, loadImages, boundCallback, true, 2, state);
            }
        }

        if (this._fortification.Get() != this._renderFortLevel) {
            if (this._fortification.Get() > 4) {
                LOGGER.Log("err", "Illegal fortification level " + this._fortification.Get());
                throw new Error("ILLEGAL FORTIFICATION LEVEL " + this._fortification.Get());
            }

            this._renderFortLevel = this._fortification.Get();
            fortImageDataA = GLOBAL._buildingProps[this._type - 1].fortImgData;

            if (fortImageDataA[this._fortification.Get()]) {
                fortImageDataB = fortImageDataA[this._fortification.Get()];
                fortImageLevel = this._fortification.Get();
            } else {
                j = this._fortification.Get() - 1;
                // Fix: Corrected loop variable from i to j based on AS3 logic intent
                while (j > 0) {
                    if (fortImageDataA[j]) {
                        fortImageDataB = fortImageDataA[j];
                        imageLevel = j;
                        break;
                    }
                    j--;
                }
            }

            if (fortImageDataB) {
                const FortImageCallback = (params: Array<any>, callbackState: string): void => {
                    let imgDataArr: Array<any>;
                    let url: string;
                    let bmd: BitmapData;
                    let container: BuildingAssetContainer;

                    if (callbackState == "fort" + this._renderFortLevel) {
                        this._fortFrontContainer.Clear();
                        this._fortBackContainer.Clear();

                        for (let item of params) {
                            url = String(item[0]);
                            bmd = item[1];

                            if (fortImageDataB["front"] && fortImageDataA.baseurl + fortImageDataB["front"][0] == url) {
                                if (!BYMConfig.instance.RENDERER_ON) {
                                    container = this._fortFrontContainer;
                                    container.Clear();
                                    container.addChild(new Bitmap(bmd));
                                    container.x = fortImageDataB["front"][1].x;
                                    container.y = fortImageDataB["front"][1].y;
                                } else {
                                    this._offsets[BFOUNDATION._RASTERDATA_FORTFRONT].x = fortImageDataB["front"][1].x;
                                    this._offsets[BFOUNDATION._RASTERDATA_FORTFRONT].y = fortImageDataB["front"][1].y;
                                    this._rasterPt[BFOUNDATION._RASTERDATA_FORTFRONT].x = this._mc.x + this._offsets[BFOUNDATION._RASTERDATA_FORTFRONT].x - MAP.instance.offset.x;
                                    this._rasterPt[BFOUNDATION._RASTERDATA_FORTFRONT].y = this._mc.y + this._offsets[BFOUNDATION._RASTERDATA_FORTFRONT].y - MAP.instance.offset.y;
                                    this._rasterData[BFOUNDATION._RASTERDATA_FORTFRONT] = this._rasterData[BFOUNDATION._RASTERDATA_FORTFRONT] || new RasterData(bmd, this._rasterPt[BFOUNDATION._RASTERDATA_FORTFRONT], Number.MAX_VALUE);
                                }
                            } else if (fortImageDataB["back"] && fortImageDataA.baseurl + fortImageDataB["back"][0] == url) {
                                if (!BYMConfig.instance.RENDERER_ON) {
                                    container = this._fortBackContainer;
                                    container.Clear();
                                    container.addChild(new Bitmap(bmd));
                                    container.x = fortImageDataB["back"][1].x;
                                    container.y = fortImageDataB["back"][1].y;
                                } else {
                                    this._offsets[BFOUNDATION._RASTERDATA_FORTBACK].x = fortImageDataB["back"][1].x;
                                    this._offsets[BFOUNDATION._RASTERDATA_FORTBACK].y = fortImageDataB["back"][1].y;
                                    this._rasterPt[BFOUNDATION._RASTERDATA_FORTBACK].x = this._mc.x + this._offsets[BFOUNDATION._RASTERDATA_FORTBACK].x - MAP.instance.offset.x;
                                    this._rasterPt[BFOUNDATION._RASTERDATA_FORTBACK].y = this._mc.y + this._offsets[BFOUNDATION._RASTERDATA_FORTBACK].y - MAP.instance.offset.y;
                                    this._rasterData[BFOUNDATION._RASTERDATA_FORTBACK] = this._rasterData[BFOUNDATION._RASTERDATA_FORTBACK] || new RasterData(bmd, this._rasterPt[BFOUNDATION._RASTERDATA_FORTBACK], Number.MAX_VALUE);
                                }
                            }
                        }
                        this.updateRasterData();
                    }
                };

                loadFortImages = [];
                if (fortImageDataB["front"]) {
                    loadFortImages.push(fortImageDataA.baseurl + fortImageDataB["front"][0]);
                }
                if (fortImageDataB["back"]) {
                    loadFortImages.push(fortImageDataA.baseurl + fortImageDataB["back"][0]);
                }
                ImageCache.GetImageGroupWithCallBack("fort" + this._type + "-" + fortImageLevel, loadFortImages, FortImageCallback, true, 2, "fort" + this._renderFortLevel);
            }
        }

        if (this._renderState == null || state !== this._renderState || this._lvl.Get() != this._renderLevel) {
            this.updateRasterData();
        }
    }

    protected ImageCallback(param1: Array<any>, param2: string): void {
        let callbackHelper: ImageCallbackHelper = null;
        let isCorrectHelper: boolean = false;
        let callbackHelperIndex: number = 0;
        let isRasterTopNull: boolean = false;
        let imageArrayItem: any = null;
        let url: string = null;
        let imageBitmapData: BitmapData = null;
        let buildingAssetContainer: BuildingAssetContainer = null;
        let rect: any = null;
        let displayObj: DisplayObject = null;
        let middle: number = (this as any)._middle;

        if (this.m_isCleared) {
            return;
        }

        callbackHelperIndex = this._imageCallbackHelpers.length - 1;
        while (callbackHelperIndex >= 0) {
            // Note: checking ref property which must be set in helper constructor
            // to match the bound function used here.
            callbackHelper = this._imageCallbackHelpers[callbackHelperIndex];
            if (callbackHelper.ref === this.ImageCallback) {
                this._imageCallbackHelpers.splice(callbackHelperIndex, 1);
                isCorrectHelper = true;
            }
            callbackHelperIndex--;
        }

        // Fallback if ref match fails due to binding differences
        if (!isCorrectHelper && this._imageCallbackHelpers.length > 0) {
            callbackHelper = this._imageCallbackHelpers.pop();
        } else if (!isCorrectHelper) {
            return;
        }

        let state: string = callbackHelper.state;
        let level: number = callbackHelper.level;
        let imageDataA: any = callbackHelper.imageDataA;
        let imageDataB: any = callbackHelper.imageDataB;
        callbackHelper.clear();

        if (param2 == this._renderState) {
            this.RenderClear(false);
            if (this._lastLoadedState != null) {
                if (state === BFOUNDATION.k_STATE_DESTROYED && this._lastLoadedState === BFOUNDATION.k_STATE_DAMAGED) {
                    if (this._type == 14) {
                        SOUNDS.Play("destroytownhall");
                        if (this._type != 17 && this._type != 18) {
                            Smoke.CreatePoof(new Point(this.x, this.y + middle), middle, 1);
                        }
                    } else {
                        SOUNDS.Play(SOUNDS.DestroySoundIDForLevel(this._lvl.Get()));
                        if (this._type != 17 && this._type != 18) {
                            Smoke.CreatePoof(new Point(this.x, this.y + middle), middle, 1);
                        }
                    }
                    if (this._class != "wall" && this._class != "trap" && this._type != 15) {
                        Smoke.CreateStream(new Point(this.x, this.y + middle));
                    }
                }
                if (state == "damaged" && this._lastLoadedState == "") {
                    SOUNDS.Play(SOUNDS.DamageSoundIDForLevel(this._lvl.Get()));
                    if (this._type != 17 && this._type != 18) {
                        Smoke.CreatePoof(new Point(this.x, this.y + middle), middle, 0.5);
                    }
                }
            }

            this._lastLoadedState = state;
            if (this._mc && this._mc.hasEventListener(Event.ENTER_FRAME)) {
                this._mc.removeEventListener(Event.ENTER_FRAME, this.TickFast);
            }

            if (BYMConfig.instance.RENDERER_ON) {
                isRasterTopNull = this._rasterData[BFOUNDATION._RASTERDATA_TOP] === null;
            }

            for (let item of param1) {
                imageArrayItem = item;
                url = String(imageArrayItem[0]);
                imageBitmapData = imageArrayItem[1];

                if (imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state] && imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state][0] == url) {
                    this.m_shadowBMD = imageBitmapData;
                    if (!BYMConfig.instance.RENDERER_ON) {
                        buildingAssetContainer = this._mcBase as BuildingAssetContainer;
                        buildingAssetContainer.Clear();
                        displayObj = buildingAssetContainer.addChild(new Bitmap(imageBitmapData));
                        displayObj.blendMode = BlendMode.MULTIPLY;
                        displayObj.x = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state][1].x;
                        displayObj.y = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state][1].y;
                    } else {
                        this._offsets[BFOUNDATION._RASTERDATA_SHADOW].x = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state][1].x;
                        this._offsets[BFOUNDATION._RASTERDATA_SHADOW].y = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_SHADOW] + state][1].y;
                        this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW].x = this._mc.x + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].x - MAP.instance.offset.x;
                        this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW].y = this._mc.y + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].y - MAP.instance.offset.y;
                        this.redrawShadowData();
                        this._rasterData[BFOUNDATION._RASTERDATA_SHADOW] = this._rasterData[BFOUNDATION._RASTERDATA_SHADOW] || new RasterData(imageBitmapData, this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW], MAP.DEPTH_SHADOW, BlendMode.MULTIPLY, true);
                    }
                } else if (imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state] && imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state][0] == url) {
                    this.setupImage(BFOUNDATION._RASTERDATA_TOP, state, this.topContainer, imageDataB, imageBitmapData, Number.MAX_VALUE);
                    this.setupHit(BFOUNDATION._RASTERDATA_TOP, level, state);
                    if (isRasterTopNull) {
                        this.updateRasterData();
                    }
                } else if (imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM] + state] && imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM] + state][0] == url) {
                    this._animBMD = imageBitmapData;
                    this._animLoaded = true;
                    rect = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM] + state][1];
                    this._animRect = new Rectangle(0, 0, rect.width, rect.height);
                    this._animFrames = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM] + state][2];

                    if (this._animRandomStart) {
                        this._animTick = Math.floor(Math.random() * (this._animFrames - 2));
                    } else {
                        this._animTick = 0;
                    }
                    if (this._type == 9 || this._type == 19 || this._type == 25 || this._type == 54) {
                        this._animTick = 0;
                    }
                    this._animContainerBMD = new BitmapData(rect.width, rect.height, true, 16777215);
                    this.setupImage(BFOUNDATION._RASTERDATA_ANIM, state, this.animContainer, imageDataB, this._animContainerBMD, Number.MAX_VALUE);
                    this.AnimFrame(false);
                    if (!this._mc.hasEventListener(Event.ENTER_FRAME)) {
                        this._mc.addEventListener(Event.ENTER_FRAME, this.TickFast);
                    }
                    if (!imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state]) {
                        this.setupHit(BFOUNDATION._RASTERDATA_ANIM, level, state);
                    }
                }
                else if (imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM2] + state] && imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM2] + state][0] == url) {
                   this._anim2BMD = imageBitmapData;
                   this._anim2Loaded = true;
                   rect = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM2] + state][1];
                   this._anim2Rect = new Rectangle(0, 0, rect.width, rect.height);
                   this._anim2Frames = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM2] + state][2];
                   if (this._animRandomStart) {
                       this._anim2Tick = Math.floor(Math.random() * (this._anim2Frames - 2));
                   } else {
                       this._anim2Tick = 0;
                   }
                   this._anim2ContainerBMD = new BitmapData(rect.width, rect.height, true, 16777215);
                   this.setupImage(BFOUNDATION._RASTERDATA_ANIM2, state, this.anim2Container, imageDataB, this._anim2ContainerBMD, Number.MAX_VALUE);
                   if (this._animLoaded && this._anim2Loaded && this._anim3Loaded) {
                       this.AnimFrame(false);
                       if (!this._mc.hasEventListener(Event.ENTER_FRAME)) {
                           this._mc.addEventListener(Event.ENTER_FRAME, this.TickFast);
                       }
                   }
                   if (!imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state]) {
                       this.setupHit(BFOUNDATION._RASTERDATA_ANIM2, level, state);
                   }
                }
                else if (imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM3] + state] && imageDataA.baseurl + imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM3] + state][0] == url) {
                   this._anim3BMD = imageBitmapData;
                   this._anim3Loaded = true;
                   rect = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM3] + state][1];
                   this._anim3Rect = new Rectangle(0, 0, rect.width, rect.height);
                   this._anim3Frames = imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_ANIM3] + state][2];
                   if (this._animRandomStart) {
                       this._anim3Tick = Math.floor(Math.random() * (this._anim3Frames - 2));
                   } else {
                       this._anim3Tick = 0;
                   }
                   this._anim3ContainerBMD = new BitmapData(rect.width, rect.height, true, 16777215);
                   this.setupImage(BFOUNDATION._RASTERDATA_ANIM3, state, this.anim3Container, imageDataB, this._anim3ContainerBMD, Number.MAX_VALUE);
                   if (this._animLoaded && this._anim2Loaded && this._anim3Loaded) {
                       this.AnimFrame(false);
                       if (!this._mc.hasEventListener(Event.ENTER_FRAME)) {
                           this._mc.addEventListener(Event.ENTER_FRAME, this.TickFast);
                       }
                   }
                   if (!imageDataB[BFOUNDATION._IMAGE_NAMES[BFOUNDATION._RASTERDATA_TOP] + state]) {
                       this.setupHit(BFOUNDATION._RASTERDATA_ANIM3, level, state);
                   }
                }
                else if (imageDataB.topdestroyedfire && this._oldRenderState == BFOUNDATION.k_STATE_DAMAGED && !GLOBAL._catchup && imageDataA.baseurl + imageDataB.topdestroyedfire[0] == url) {
                    Fire.Add(this._mc, new Bitmap(imageBitmapData), new Point(imageDataB.topdestroyedfire[1].x, imageDataB.topdestroyedfire[1].y));
                }
            }
        }

        if (BYMConfig.instance.RENDERER_ON) {
            if (!this._animLoaded && this._rasterData[BFOUNDATION._RASTERDATA_ANIM] instanceof RasterData) {
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM].clear();
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM] = null;
            }
            if (!this._anim2Loaded && this._rasterData[BFOUNDATION._RASTERDATA_ANIM2] instanceof RasterData) {
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM2].clear();
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM2] = null;
            }
            if (!this._anim3Loaded && this._rasterData[BFOUNDATION._RASTERDATA_ANIM3] instanceof RasterData) {
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM3].clear();
                this._rasterData[BFOUNDATION._RASTERDATA_ANIM3] = null;
            }
        }
        this.AnimFrame();
    }

    protected setupImage(index: number, state: string, container: BuildingAssetContainer, imageDataB: any, bmd: BitmapData, depth: number): void {
        this._offsets[index].x = imageDataB[BFOUNDATION._IMAGE_NAMES[index] + state][1].x;
        this._offsets[index].y = imageDataB[BFOUNDATION._IMAGE_NAMES[index] + state][1].y;

        if (!BYMConfig.instance.RENDERER_ON) {
            container.Clear();
            container.addChild(new Bitmap(bmd));
            container.x = this._offsets[index].x;
            container.y = this._offsets[index].y;
        } else {
            this._rasterPt[index].x = this._mc.x + this._offsets[index].x - MAP.instance.offset.x;
            this._rasterPt[index].y = this._mc.y + this._offsets[index].y - MAP.instance.offset.y;
            this._rasterData[index] = this._rasterData[index] || new RasterData(bmd, this._rasterPt[index], Number.MAX_VALUE);
            this._rasterData[index].data = bmd;
            this._rasterData[index].visible = this._mc.visible;
            this._sources[index] = container;
        }
    }

    protected setupHit(index: number, level: number, state: string): void {
        if (MovieClipUtils.validateFrameLabel(this._mcHit, "f" + level + state)) {
            this._mcHit.gotoAndStop("f" + level + state);
        }
        if (state == "destroyed" && this._type !== 14) {
            if (MovieClipUtils.validateFrameLabel(this._mcHit, "f" + state)) {
                this._mcHit.gotoAndStop("f" + state);
            } else if (GLOBAL._aiDesignMode) {
                console.log("BFOUNDATION.ImageCallback building has no hit 1 " + this._type + " frame f" + state);
            }
        }
        this.m_hitOffsetIndex = index;
        if (BYMConfig.instance.RENDERER_ON) {
            this._mcHit.x = this._mc.x + this._offsets[index].x;
            this._mcHit.y = this._mc.y + this._offsets[index].y;
        } else {
            this._mcHit.x = this._offsets[index].x;
            this._mcHit.y = this._offsets[index].y;
        }
    }

    public showFootprint(blocking: boolean, redraw: boolean = false): void {
        if (this._mcFootprint) {
            if (BYMConfig.instance.RENDERER_ON && (this._mcFootprint.width | this._mcFootprint.height) !== 0) {
                this._offsets[BFOUNDATION._RASTERDATA_FOOTPRINT].x = -this._mcFootprint.width >> 1;
                this._offsets[BFOUNDATION._RASTERDATA_FOOTPRINT].y = 0;
                this._rasterPt[BFOUNDATION._RASTERDATA_FOOTPRINT].x = this._mcFootprint.x - (this._mcFootprint.width >> 1) - MAP.instance.offset.x;
                this._rasterPt[BFOUNDATION._RASTERDATA_FOOTPRINT].y = this._mcFootprint.y - MAP.instance.offset.y;

                if (!this.m_footprintBMD) {
                    this.m_footprintBMD = new BitmapData(this._mcFootprint.width, this._mcFootprint.height, true, 0);
                    this.m_footprintBMD.draw(this._mcFootprint, new Matrix(1, 0, 0, 1, this._mcFootprint.width * 0.5, 0));
                } else if (redraw) {
                    this.m_footprintBMD.fillRect(this.m_footprintBMD.rect, 0);
                    this.m_footprintBMD.draw(this._mcFootprint, new Matrix(1, 0, 0, 1, this._mcFootprint.width * 0.5, 0));
                }

                this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT] = this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT] || new RasterData(this.m_footprintBMD, this._rasterPt[BFOUNDATION._RASTERDATA_FOOTPRINT], MAP.DEPTH_SHADOW + 1);

                if (redraw) {
                    this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT].data = this.m_footprintBMD;
                }

                if ((GLOBAL._selectedBuilding === this || GLOBAL._newBuilding === this) && this._rasterData[BFOUNDATION._RASTERDATA_SHADOW] instanceof RasterData) {
                    this._rasterData[BFOUNDATION._RASTERDATA_SHADOW].visible = false;
                }
            } else {
                this._mcFootprint.visible = true;
            }
        }
        if (blocking) {
            this.BlockClicks();
        }
    }

    public hideFootprint(unblock: boolean): void {
        if (GLOBAL._selectedBuilding != this) {
            if (BYMConfig.instance.RENDERER_ON && this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT] instanceof RasterData) {
                this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT].clear();
                this._rasterData[BFOUNDATION._RASTERDATA_FOOTPRINT] = null;
            }
            if (this._mcFootprint) {
                this._mcFootprint.visible = false;
            }
        }
        if (this._mcFootprint) {
            this._mcFootprint.gotoAndStop(1);
        }
        if (unblock) {
            this.UnblockClicks();
        }
        this.updateRasterData();
    }

    public get tickLimit(): number {
        if (this.health == 0 && !this._repairing) {
            return BFOUNDATION.TICK_LIMIT;
        }
        let limit: number = BFOUNDATION.TICK_LIMIT;
        if (this._countdownBuild.Get() > 0) {
            limit = Math.min(limit, this._countdownBuild.Get());
        }
        if (this._countdownUpgrade.Get() > 0) {
            limit = Math.min(limit, this._countdownUpgrade.Get());
        }
        if (this._countdownFortify.Get() > 0) {
            limit = Math.min(limit, this._countdownFortify.Get());
        }
        return limit;
    }

    public Tick(amount: number): void {
        let repairAmount: number = 0;
        let repairIndex: number = 0;

        if (this._countdownBuild.Get() + this._countdownUpgrade.Get() + this._countdownFortify.Get() + this._repairing > 0) {
            if (this._repairing == 1) {
                repairIndex = this._lvl.Get() == 0 ? 0 : Math.floor(this._lvl.Get() - 1);
                repairAmount = Math.ceil(this.maxHealth / Math.min(3600, this._buildingProps.repairTime[repairIndex]));
                this.setHealth(this.health + repairAmount * amount);
                if (this.health >= this.maxHealth) {
                    this.Repaired();
                }
            } else if (this.health == this.maxHealth) {
                if (this._countdownUpgrade.Get() > 0 && this._hasWorker && this._hasResources) {
                    this._countdownUpgrade.Add(-amount);
                    if (!Math.max(this._countdownUpgrade.Get(), 0)) {
                        this.Upgraded();
                    }
                } else if (this._countdownBuild.Get() > 0 && this._hasWorker && this._hasResources) {
                    this._countdownBuild.Add(-amount);
                    if (!Math.max(this._countdownBuild.Get(), 0)) {
                        this.Constructed();
                    }
                } else if (this._countdownFortify.Get() > 0 && this._hasWorker && this._hasResources) {
                    this._countdownFortify.Add(-amount);
                    if (!Math.max(this._countdownFortify.Get(), 0)) {
                        this.Fortified();
                    }
                }
            }
        }
        this.Update();
    }

    protected override updateRasterData(): void {
        let rasterData: RasterData = null;
        let point: Point = null;
        let halfHeight: number = 0;
        let depth: number = 0;
        let source: DisplayObject = null;
        let i: number = 0;

        if (!BYMConfig.instance.RENDERER_ON || this.m_isCleared) {
            return;
        }

        let offset: Point = MAP.instance.offset;
        let intersects: Function = MAP.instance.viewRect.intersects.bind(MAP.instance.viewRect);
        let rect: Rectangle = new Rectangle();

        if (this._mcHit) {
            this._mcHit.x = this._mc.x + this._offsets[this.m_hitOffsetIndex].x;
            this._mcHit.y = this._mc.y + this._offsets[this.m_hitOffsetIndex].y;
        }

        if (this._mc) {
            halfHeight = this._mc.height * 0.5;
            if ((this as any)._middle) {
                halfHeight = (this as any)._middle;
            }
            this.m_baseDepth = 0;
            depth = Math.max(MAP.DEPTH_SHADOW + 1, (this._mc.y - offset.y + halfHeight) * 1000 + (this._mc.x - offset.x));
            i = BFOUNDATION._RASTERDATA_SHADOW + 1;

            while (i < BFOUNDATION._RASTERDATA_AMOUNT) {
                rasterData = this._rasterData[i];
                point = this._rasterPt[i];
                if (rasterData && point) {
                    this.m_baseDepth = i - 1;
                    rasterData.depth = i === BFOUNDATION._RASTERDATA_FORTBACK ? depth - 1 : depth + i - 1;
                    point.x = this._mc.x + this._offsets[i].x - offset.x;
                    point.y = this._mc.y + this._offsets[i].y - offset.y;
                    source = this._sources[i];
                    rect.x = point.x;
                    rect.y = point.y;
                    rect.width = rasterData.rect.width;
                    rect.height = rasterData.rect.height;
                    rasterData.visible = intersects(rect) && (source && !source.visible ? false : this._mc.visible);
                    rasterData.alpha = this._mc.alpha;
                }
                i++;
            }

            rasterData = this._rasterData[BFOUNDATION._RASTERDATA_SHADOW];
            point = this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW];

            if (this._mcBase && rasterData && point) {
                point.x = this._mcBase.x + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].x - offset.x;
                point.y = this._mcBase.y + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].y - offset.y;
                if (!this._moving && GLOBAL._newBuilding !== this) {
                    rect.x = point.x;
                    rect.y = point.y;
                    rect.width = rasterData.rect.width;
                    rect.height = rasterData.rect.height;
                    rasterData.visible = intersects(rect) && this._mcBase.visible;
                }
            }
        }
        super.updateRasterData();
    }

    protected redrawShadowData(): void {
        let bmd: BitmapData = null;
        if (!BYMConfig.instance.RENDERER_ON || !BYMConfig.instance.OPTIMIZED_SHADOWS || !this.m_shadowBMD) {
            return;
        }
        let offset: Point = MAP.instance.offset;
        let pt: Point = this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW];
        if (this._mcBase && pt) {
            pt.x = this._mcBase.x + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].x - offset.x;
            pt.y = this._mcBase.y + this._offsets[BFOUNDATION._RASTERDATA_SHADOW].y - offset.y;
        }

        bmd = new BitmapData(this.m_shadowBMD.width, this.m_shadowBMD.height, true);
        let rect: Rectangle = new Rectangle(this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW].x, this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW].y, bmd.width, bmd.height);
        bmd.copyPixels(MAP.effectsBMD, rect, new Point());
        bmd.draw(this.m_shadowBMD, null, null, BlendMode.MULTIPLY);

        if (!(this._rasterData[BFOUNDATION._RASTERDATA_SHADOW] instanceof RasterData)) {
            this._rasterData[BFOUNDATION._RASTERDATA_SHADOW] = new RasterData(bmd, this._rasterPt[BFOUNDATION._RASTERDATA_SHADOW], MAP.DEPTH_SHADOW, null, true);
        } else {
            this._rasterData[BFOUNDATION._RASTERDATA_SHADOW].data = bmd;
        }

        if (!this._moving) {
            this._rasterData[BFOUNDATION._RASTERDATA_SHADOW].visible = this._mcBase.visible;
        }
    }

    public TickFast(e: Event = null): void {
        // Method was empty in AS3 source
    }

    public TickAttack(): void {
        // Method was empty in AS3 source
    }

    public AnimFrame(update: boolean = true): void {
        let changed: boolean = false;
        if (!GLOBAL._catchup && this._animBMD && this._animContainerBMD) {
            this._animRect.x = this._animRect.width * this._animTick;
            this._animContainerBMD.copyPixels(this._animBMD, this._animRect, this._nullPoint);
            changed = true;
            if (update) {
                if (this._class == "resource") {
                    if (GLOBAL._harvesterOverdrive >= GLOBAL.Timestamp() && GLOBAL._harvesterOverdrivePower.Get() > 0) {
                        this._animTick += GLOBAL._harvesterOverdrivePower.Get();
                    } else {
                        this._animTick++;
                    }
                } else {
                    this._animTick++;
                }
                if (this._animTick >= this._animFrames) {
                    this._animTick = 0;
                }
            }
        }
        
        if (!GLOBAL._catchup && this._anim2BMD) {
            this._anim2Rect.x = this._anim2Rect.width * this._anim2Tick;
            this._anim2ContainerBMD.copyPixels(this._anim2BMD, this._anim2Rect, this._nullPoint);
            changed = true;
            if (update) {
                this._anim2Tick++;
                if (this._anim2Tick >= this._anim2Frames) {
                    this._anim2Tick = 0;
                }
            }
        }
        if (!GLOBAL._catchup && this._anim3BMD) {
            this._anim3Rect.x = this._anim3Rect.width * this._anim3Tick;
            this._anim3ContainerBMD.copyPixels(this._anim3BMD, this._anim3Rect, this._nullPoint);
            changed = true;
            if (update) {
                this._anim3Tick++;
                if (this._anim3Tick >= this._anim3Frames) {
                    this._anim3Tick = 0;
                }
            }
        }
        
        if (changed) {
            this.updateRasterData();
        }
    }

    public Instructions(): void {
        this._buildingInstructions += KEYS.Get("building_instructions");
    }

    public FollowMouse(): void {
        if (BYMConfig.instance.RENDERER_ON) {
            this.showFootprint(true);
        }
        this.updateRasterData();
        this._mc.addEventListener(Event.ENTER_FRAME, this.FollowMouseB);
        MAP._GROUND.addEventListener(MouseEvent.MOUSE_UP, this.Place);
        this._mc.addEventListener(MouseEvent.MOUSE_DOWN, MAP.Click);
        this.Render(BFOUNDATION.k_STATE_DEFAULT);
    }

    public FollowMouseB = (e: Event = null): void => {
        let blockers: string = BASE.BuildBlockers(this, this._class == "decoration");
        let currentFrame: number = this._mcFootprint.currentFrame;
        this._mc.x = Math.floor((MAP._GROUND.mouseX - this._mouseOffset.x) / 10) * 10;
        this._mc.y = Math.floor((MAP._GROUND.mouseY - this._mouseOffset.y) / 5) * 5;
        this._mcBase.x = this._mc.x;
        this._mcBase.y = this._mc.y;
        this.updateRasterData();

        if (this._mcFootprint) {
            this._mcFootprint.x = this._mc.x;
            this._mcFootprint.y = this._mc.y;
            if (blockers != "") {
                this._mcFootprint.gotoAndStop(2);
            } else {
                this._mcFootprint.gotoAndStop(1);
            }
        }
        this.showFootprint(false, currentFrame !== this._mcFootprint.currentFrame);
        if (!BYMConfig.instance.RENDERER_ON) {
            MAP.SortDepth();
        }
    }

    public Cancel(): void {
        if (GLOBAL._newBuilding === this) {
            this.clear();
        }
        GLOBAL._newBuilding = null;
        if (this._mc) {
            this._mc.removeEventListener(Event.ENTER_FRAME, this.FollowMouseB);
            this._mc.removeEventListener(MouseEvent.MOUSE_DOWN, MAP.Click);
        }
        MAP._GROUND.removeEventListener(MouseEvent.MOUSE_UP, this.Place);
        if (this._mcBase.parent) {
            this._mcBase.parent.removeChild(this._mcBase);
        }
        if (this._mc.parent) {
            this._mc.parent.removeChild(this._mc);
        }
        if (this._mcHit.parent) {
            this._mcHit.parent.removeChild(this._mcHit);
        }
        if (this._mcFootprint.parent) {
            this._mcFootprint.parent.removeChild(this._mcFootprint);
        }
        BASE.BuildingDeselect();
        this.clearRasterData();
    }

    protected clearRasterData(): void {
        let rd: RasterData = null;
        let i: number = 0;
        if (!BYMConfig.instance.RENDERER_ON || !this._rasterData) {
            return;
        }
        i = this._rasterData.length - 1;
        while (i >= 0) {
            rd = this._rasterData[i];
            if (rd) {
                rd.clear();
            }
            this._rasterData[i] = null;
            i--;
        }
    }

    public Place = (e: MouseEvent = null): void => {
        let BragBiggulp: Function;
        let BragTotem: Function;
        let tmpBuildTime: number = 0;
        let fromStorage: number = 0;
        let isInfernoBuilding: boolean = false;
        let mc: MovieClip = null;
        let totemImgUrl: string = null;

        this.Description();
        if (!MAP._dragged) {
            if (BASE.BuildBlockers(this, this._class == "decoration") != "") {
                this.Cancel();
                return;
            }
            if (BASE.isInfernoMainYardOrOutpost) {
                SOUNDS.Play("inf_buildingplace");
            } else {
                SOUNDS.Play("buildingplace");
            }

            this._mc.alpha = 1;
            this._mc.removeEventListener(Event.ENTER_FRAME, this.FollowMouseB);
            MAP._GROUND.removeEventListener(MouseEvent.MOUSE_UP, this.Place);
            this._mc.removeEventListener(MouseEvent.MOUSE_DOWN, MAP.Click);

            if (BASE.CanBuild(this._type, this._buildInstant).error) {
                this.Cancel();
                GLOBAL._newBuilding = null;
                return;
            }

            GLOBAL._newBuilding = null;

            if (this._buildInstant) {
                if (!this._buildInstantCost) {
                    this.Cancel();
                    return;
                }
                if (BASE._credits.Get() < this._buildInstantCost.Get()) {
                    this.Cancel();
                    POPUPS.DisplayGetShiny();
                    return;
                }
            }

            this._hasResources = false;
            this._hasWorker = false;
            BASE._buildingCount++;
            this._id = BASE._buildingCount;
            tmpBuildTime = Math.floor(this._buildingProps.costs[0].time.Get());
            
            if (STORE._storeData.BST) {
                tmpBuildTime -= tmpBuildTime * 0.2;
            }

            this._countdownBuild.Set(tmpBuildTime);
            this.setHealth(this._buildingProps.hp[0]);
            this.maxHealthProperty.value = this.health;
            this.PlaceB();

            if (this._mc.contains(this._mcHit)) {
                this._mc.removeChild(this._mcHit);
            }
            if (BYMConfig.instance.RENDERER_ON) {
                MAP._BUILDINGTOPS.addChild(this._mcHit);
            } else {
                this._mc.addChild(this._mcHit);
            }

            this.Tick(1);
            this.Update();
            this.Description();
            fromStorage = InventoryManager.buildingStorageRemove(this._type);

            if (!fromStorage) {
                if (!this._buildInstant) {
                    isInfernoBuilding = BASE.isInfernoBuilding(this._type);
                    BASE.Charge(1, this._buildingProps.costs[0].r1.Get(), false, isInfernoBuilding);
                    BASE.Charge(2, this._buildingProps.costs[0].r2.Get(), false, isInfernoBuilding);
                    BASE.Charge(3, this._buildingProps.costs[0].r3.Get(), false, isInfernoBuilding);
                    BASE.Charge(4, this._buildingProps.costs[0].r4.Get(), false, isInfernoBuilding);
                    if (STORE._storeItems["BUILDING" + this._type]) {
                        BASE.Purchase("BUILDING" + this._type, 1, "building");
                    }
                    if (this._buildingProps.costs[0].time.Get() != 0 && InventoryManager.buildingStorageCount(this._type) == 0) {
                        QUEUE.Add("building" + this._id, this);
                    }
                } else {
                    if (this._buildInstantCost.Get() > 0) {
                        BASE.Purchase("IB", this._buildInstantCost.Get(), "building");
                    }
                    LOGGER.Stat([71, this._buildInstantCost.Get(), this._type]);
                    this.Constructed();
                }
            } else {
                this.Constructed();
                if (this._type == 120) {
                    LOGGER.Stat([75, "placedgoldenbiggulp"]);
                }
                if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD && BASE.isMainYard) {
                    BragBiggulp = (): void => {
                        GLOBAL.CallJS("sendFeed", ["biggulp-construct", KEYS.Get("pop_biggulpbuilt_streamtitle"), KEYS.Get("pop_biggulpbuilt_streambody"), "dave_711promo.png"]);
                        POPUPS.Next();
                    };
                    BragTotem = (totemType: number): Function => {
                        return (e: MouseEvent = null): void => {
                            switch (totemType) {
                                case 121:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave1streamtitle"), KEYS.Get("wmi_wave1streamdesc"), "wmitotemfeed1.1.png"]);
                                    break;
                                case 122:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave10streamtitle"), KEYS.Get("wmi_wave10streamdesc"), "wmitotemfeed2.png"]);
                                    break;
                                case 123:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave20streamtitle"), KEYS.Get("wmi_wave20streamdesc"), "wmitotemfeed3.png"]);
                                    break;
                                case 124:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave30streamtitle"), KEYS.Get("wmi_wave30streamdesc"), "wmitotemfeed4.png"]);
                                    break;
                                case 125:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave31streamtitle"), KEYS.Get("wmi_wave31streamdesc"), "wmitotemfeed5.png"]);
                                    break;
                                case 126:
                                    GLOBAL.CallJS("sendFeed", ["wmitotem-construct", KEYS.Get("wmi_wave32streamtitle"), KEYS.Get("wmi_wave32streamdesc"), "wmitotemfeed6.png"]);
                                    break;
                                case 131:
                                    switch (this._lvl.Get()) {
                                        case 1:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave1streamtitle"), KEYS.Get("wmi2_wave1streamdesc"), "wmitotemfeed2_1.png"]);
                                            break;
                                        case 2:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave10streamtitle"), KEYS.Get("wmi2_wave10streamdesc"), "wmitotemfeed2_2.png"]);
                                            break;
                                        case 3:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave20streamtitle"), KEYS.Get("wmi2_wave20streamdesc"), "wmitotemfeed2_3.png"]);
                                            break;
                                        case 4:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave30streamtitle"), KEYS.Get("wmi2_wave30streamdesc"), "wmitotemfeed2_4.png"]);
                                            break;
                                        case 5:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave31streamtitle"), KEYS.Get("wmi2_wave31streamdesc"), "wmitotemfeed2_5.png"]);
                                            break;
                                        case 6:
                                            GLOBAL.CallJS("sendFeed", ["wmi2totem-construct", KEYS.Get("wmi2_wave32streamtitle"), KEYS.Get("wmi2_wave32streamdesc"), "wmitotemfeed2_6.png"]);
                                    }
                            }
                            POPUPS.Next();
                        };
                    };

                    // Assumes popup_biggulp is a global class
                    mc = new (window as any)["popup_biggulp"]();
                    if (BASE.is711Valid()) {
                        if (this._type == 120) {
                            mc["tA"].htmlText = "<b>" + KEYS.Get("pop_biggulpbuilt_title") + "</b>";
                            mc["tB"].htmlText = KEYS.Get("pop_biggulpbuilt_body");
                            mc["bPost"].SetupKey("btn_brag");
                            mc["bPost"].addEventListener(MouseEvent.CLICK, BragBiggulp);
                            mc["bPost"].Highlight = true;
                            POPUPS.Push(mc, null, null, null, "building-biggulp.png");
                        }
                    }

                    totemImgUrl = "";
                    if (BTOTEM.IsTotem(this._type)) {
                        mc["tA"].htmlText = "<b>" + KEYS.Get("wmi_totemwon") + "</b>";
                        mc["tB"].htmlText = "";
                        mc["bPost"].SetupKey("btn_brag");
                        mc["bPost"].addEventListener(MouseEvent.CLICK, BragTotem(this._type));
                        mc["bPost"].Highlight = true;
                        switch (this._lvl.Get()) {
                            case 1: totemImgUrl = "building-wmitotem1.png"; break;
                            case 2: totemImgUrl = "building-wmitotem2.png"; break;
                            case 3: totemImgUrl = "building-wmitotem3.png"; break;
                            case 4: totemImgUrl = "building-wmitotem4.png"; break;
                            case 5: totemImgUrl = "building-wmitotem5.png"; break;
                            case 6: totemImgUrl = "building-wmitotem6.png"; break;
                            default: totemImgUrl = "building-wmitotem6.png";
                        }
                        POPUPS.Push(mc, null, null, null, totemImgUrl);
                    } else if (BTOTEM.IsTotem2(this._type)) {
                        mc["tA"].htmlText = "<b>" + KEYS.Get("wmi2_totemwon") + "</b>";
                        mc["tB"].htmlText = "";
                        mc["bPost"].SetupKey("btn_brag");
                        mc["bPost"].addEventListener(MouseEvent.CLICK, BragTotem(this._type));
                        mc["bPost"].Highlight = true;
                        switch (this._lvl.Get()) {
                            case 1: totemImgUrl = "building-wmi2totem1.png"; break;
                            case 2: totemImgUrl = "building-wmi2totem2.png"; break;
                            case 3: totemImgUrl = "building-wmi2totem3.png"; break;
                            case 4: totemImgUrl = "building-wmi2totem4.png"; break;
                            case 5: totemImgUrl = "building-wmi2totem5.png"; break;
                            case 6: totemImgUrl = "building-wmi2totem6.png"; break;
                            default: totemImgUrl = "building-wmi2totem6.png";
                        }
                        POPUPS.Push(mc, null, null, null, totemImgUrl);
                    }
                }
            }

            if (BASE._pendingPurchase.length == 0) {
                BASE.Save();
            }
            UPDATES.Create(["BP", this._type, this.Export()]);
            LOGGER.Stat([5, this._type]);
        }
        this.updateRasterData();
        this.onMove();
    }

    public PlaceB(): void {
        this._position = new Point(this._mc.x, this._mc.y);
        this._mc.mouseEnabled = false;
        this._mcBase.mouseEnabled = false;
        this._mcBase.x = this._mc.x;
        this._mcBase.y = this._mc.y;
        this._mc.alpha = 1;
        this._mcFootprint.x = this._mc.x;
        this._mcFootprint.y = this._mc.y;

        if (GLOBAL.mode != GLOBAL.e_BASE_MODE.ATTACK && GLOBAL.mode != GLOBAL.e_BASE_MODE.WMATTACK || this._senderid == LOGIN._playerID) {
            this._mcHit.mouseEnabled = true;
            this._mcHit.buttonMode = true;
            this.setupListeners();
        } else {
            this._mc.mouseEnabled = false;
            this._mc.mouseChildren = false;
            this._mcHit.mouseEnabled = false;
            this._mcHit.mouseChildren = false;
            this._mcHit.buttonMode = false;
        }

        if (!(this._destroyed && GLOBAL.mode != GLOBAL.e_BASE_MODE.BUILD)) {
            this.GridCost(true);
        }

        if (this._type == 7) {
            BASE._buildingsMushrooms["m" + this._id] = this;
        } else {
            BASE.buildings.push(this);
            BASE._buildingsAll["b" + this._id] = this;
            if (this._class == "wall") {
                BASE._buildingsWalls["b" + this._id] = this;
            } else if (this._class == "trap") {
                BASE._buildingsTowers["b" + this._id] = this;
            } else if (this._class == "tower") {
                BASE._buildingsTowers["b" + this._id] = this;
                BASE._buildingsMain["b" + this._id] = this;
                if (MONSTERBUNKER.isBunkerBuilding(this._type)) {
                    BASE._buildingsBunkers["b" + this._id] = this;
                }
            } else if (this._class == "gift" || this._class == "taunt") {
                BASE._buildingsGifts["b" + this._id] = this;
            } else if (this._class != "cage") {
                BASE._buildingsMain["b" + this._id] = this;
            }
        }

        if (!GLOBAL._catchup && !BASE.processing) {
            BASE.HideFootprints();
        }
        if (this._class != "mushroom") {
            BuildingOverlay.Setup(this);
        }
        this.Description();
        this.Update();
        this._placing = false;
        if (this._class != "wall" && this._class != "trap") {
            BUILDINGS._buildingID = 0;
        }
        GLOBAL.eventDispatcher.dispatchEvent(new BuildingEvent(BuildingEvent.PLACED_FOR_CONSTRUCTION, this));
        this.updateRasterData();
    }

    public Destroyed(animate: boolean = true): void {
        let time: number;
        let halfTime: number;
        let newTime: number;

        if (!this._destroyed) {
            this._destroyed = true;
            ATTACK.Damage(this._mc.x, this._mc.y, this._buildingProps.hp[this._lvl.Get() - 1]);
            
            if (this._repairing == 1) {
                this._repairing = 0;
                QUEUE.Remove("building" + this._id, true, this);
                ATTACK.Log("b" + this._id, "<font color=\"#FF0000\">" + KEYS.Get("attack_log_downed_repaircancel", {
                    "v1": this._lvl.Get(),
                    "v2": KEYS.Get(this._buildingProps.name)
                }) + "</font>");
            } else if (this._countdownBuild.Get() > 0) {
                ATTACK.Damage(this._mc.x, this._mc.y, this._buildingProps.hp[this._lvl.Get()]);
                ATTACK.Log("b" + this._id, "<font color=\"#FF0000\">" + KEYS.Get("attack_log_downed_buildcancel", {
                    "v1": this._lvl.Get(),
                    "v2": KEYS.Get(this._buildingProps.name)
                }) + "</font>");
            } else if (this._countdownUpgrade.Get()) {
                ATTACK.Damage(this._mc.x, this._mc.y, this._buildingProps.hp[this._lvl.Get()]);
                time = Math.floor(this._buildingProps.costs[this._lvl.Get()].time.Get() * GLOBAL._buildTime);
                halfTime = (time - this._countdownUpgrade.Get()) * 0.5;
                if (halfTime > 60 * 60 * 8) {
                    halfTime = 60 * 60 * 8;
                }
                if ((newTime = this._countdownUpgrade.Get() + halfTime) < 0) {
                    newTime = 0;
                }
                ATTACK.Log("b" + this._id, "<font color=\"#FF0000\">" + KEYS.Get("attack_log_downed_upgradecancel", {
                    "v1": this._lvl.Get(),
                    "v2": KEYS.Get(this._buildingProps.name),
                    "v3": this._lvl.Get() + 1
                }) + "</font>");
                this._countdownUpgrade.Set(newTime);
            } else {
                ATTACK.Log("b" + this._id, "<font color=\"#FF0000\">" + KEYS.Get("attack_log_downed", {
                    "v1": this._lvl.Get(),
                    "v2": KEYS.Get(this._buildingProps.name)
                }) + "</font>");
            }
            this.Update(true);
            this.GridCost(false);
            PATHING.ResetCosts();
            BASE.Save();
        }
        this._repairing = 0;
    }

    public Repair(): void {
        this._repairing = 1;
        this._destroyed = false;
        this.Update();
        BASE.Save();
    }

    public Repaired(): void {
        this._repairing = 0;
        this.setHealth(this.maxHealth);
        if (this._type == 15 || this._type == 128) {
            HOUSING.HousingSpace();
        }
        this.Description();
        UI2.Update();
    }

    public HasWorker(): void {
        let i: number = 0;
        let j: number = 0;
        let res: number = 0;
        this._hasWorker = true;
        if (this._countdownBuild.Get() + this._countdownUpgrade.Get() + this._countdownFortify.Get() > 0) {
            i = (BASE.isInfernoBuilding(this._type) || BASE.isInfernoMainYardOrOutpost) ? 5 : 1;
            j = 1;
            while (j < 5) {
                res = this._buildingProps.costs[this._lvl.Get()] ? Number(this._buildingProps.costs[this._lvl.Get()]["r" + j].Get()) : 0;
                if (!res && this._buildingProps.fortify_costs) {
                    res = this._buildingProps.fortify_costs[this._fortification.Get()] ? Number(this._buildingProps.fortify_costs[this._fortification.Get()]["r" + j].Get()) : 0;
                }
                if (res) {
                    ResourcePackages.Create(i, this, res, true);
                }
                i++;
                j++;
            }
        }
    }

    public Over = (e: MouseEvent): void => {
        GLOBAL._buildingMousedOver = this;
    }

    public Out = (e: MouseEvent): void => {
        // Stub
    }

    public FinishNowCost(): number {
        let time: number = 0;
        let c1: number = 0;
        let c2: number = 0;
        let doMin: boolean = true;

        if (this._countdownBuild.Get() > 0) {
            time = this._countdownBuild.Get();
        }
        if (this._countdownUpgrade.Get() > 0) {
            time = this._countdownUpgrade.Get();
        }
        if (this._countdownFortify.Get() > 0) {
            time = this._countdownFortify.Get();
        }
        if (doMin && time <= 300) {
            return 0;
        }
        c1 = Math.ceil(time * 20 / 60 / 60);
        c2 = Math.floor(Math.sqrt(time * 0.8));
        return Math.min(c1, c2);
    }

    public InstantBuildCost(): number {
        let cost: any = GLOBAL._buildingProps[this._type - 1].costs[0];
        let time: number = Math.floor(cost.time.Get());
        if (time <= 300) {
            time = 0;
        }
        let res: number = cost.r1.Get() + cost.r2.Get() + cost.r3.Get();
        let c1: number = Math.ceil(Math.pow(Math.sqrt(res / 2), 0.75));
        let c2: number = STORE.GetTimeCost(time);
        let total: number = c1 + c2;
        return Math.floor(total * 0.95);
    }

    public InstantFortifyCost(): number {
        if (this._buildingProps.fortify_costs.length <= this._fortification.Get()) {
            return 0;
        }
        let cost: any = this._buildingProps.fortify_costs[this._fortification.Get()];
        let time: number = Math.floor(cost.time.Get());
        if (time <= 300) {
            time = 0;
        }
        let res: number = cost.r1.Get() + cost.r2.Get() + cost.r3.Get();
        let c1: number = Math.ceil(Math.pow(Math.sqrt(res / 2), 0.75));
        let c2: number = STORE.GetTimeCost(time);
        let total: number = c1 + c2;
        return Math.floor(total * 0.95);
    }

    public InstantUpgradeCost(): number {
        if (this._buildingProps.costs.length <= this._lvl.Get()) {
            return 0;
        }
        let cost: any = this._buildingProps.costs[this._lvl.Get()];
        let time: number = Math.floor(cost.time.Get());
        if (time <= 300) {
            time = 0;
        }
        let res: number = cost.r1.Get() + cost.r2.Get() + cost.r3.Get();
        let c1: number = Math.ceil(Math.pow(Math.sqrt(res / 2), 0.75));
        let c2: number = STORE.GetTimeCost(time);
        let total: number = c1 + c2;
        return Math.floor(total * 0.95);
    }

    public DoInstantUpgrade(): boolean {
        let cost: number = this.InstantUpgradeCost();
        if (BASE._credits.Get() >= cost) {
            this.Upgraded();
            BASE.Purchase("IU", cost, "upgrade");
            LOGGER.Stat([72, cost, this._type, this._lvl.Get()]);
            return true;
        }
        POPUPS.DisplayGetShiny();
        return false;
    }

    public DoInstantFortify(): boolean {
        let cost: number = this.InstantFortifyCost();
        if (BASE._credits.Get() >= cost) {
            this.Fortified();
            BASE.Purchase("IF", cost, "fortify");
            return true;
        }
        POPUPS.DisplayGetShiny();
        return false;
    }

    public Fortify(): boolean {
        let canFortify: any;
        if (!QUEUE.CanDo().error) {
            canFortify = BASE.CanFortify(this);
            if (!canFortify.error) {
                if (Math.floor(this._buildingProps.fortify_costs[this._fortification.Get()].time.Get() * GLOBAL._buildTime) > 3600) {
                    UPDATES.Create(["BF", this._id]);
                }
                this.FortifyB();
                BASE.Save();
                return true;
            }
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(canFortify.errorMessage);
            }
        } else if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
            POPUPS.DisplayWorker(3, this);
        }
        return false;
    }

    public FortifyB(): void {
        let canFortify: any;
        let cost: any;
        let time: number;

        if (this._countdownFortify.Get() == 0) {
            canFortify = BASE.CanFortify(this);
            if (!canFortify.error) {
                cost = this.FortifyCost();
                if (cost.r1.Get() > 0) BASE.Charge(1, cost.r1.Get());
                if (cost.r2.Get() > 0) BASE.Charge(2, cost.r2.Get());
                if (cost.r3.Get() > 0) BASE.Charge(3, cost.r3.Get());
                if (cost.r4.Get() > 0) BASE.Charge(4, cost.r4.Get());

                time = Math.floor(this._buildingProps.fortify_costs[this._fortification.Get()].time.Get() * GLOBAL._buildTime);
                this._countdownFortify.Set(time);
                this._hasResources = false;
                this._hasWorker = false;
                if (GLOBAL._catchup) {
                    this._hasResources = true;
                    this._hasWorker = true;
                }
                QUEUE.Add("building" + this._id, this);
                LOGGER.Stat([64, this._type, this._fortification.Get() + 1]);
                this._helpList = [];
                this.Update();

                if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD && this._class == "tower") {
                    GLOBAL._selectedBuilding = this;
                    GLOBAL.Message(KEYS.Get("msg_inactivefortify"), KEYS.Get("btn_speedup"), STORE.SpeedUp, ["SP4"]);
                }
            } else if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(canFortify.errorMessage);
            }
        }
    }

    public FortifyCancel(): void {
        GLOBAL.Message(KEYS.Get("msg_fortifycancelconfirm"), KEYS.Get("msg_stopfortifying_btn"), this.FortifyCancelB);
    }

    public FortifyCancelB = (e: MouseEvent = null): void => {
        UPDATES.Create(["BFC", this._id]);
        this.FortifyCancelC();
    }

    public FortifyCancelC(): void {
        let cost: any;
        if (this._countdownFortify.Get() > 0) {
            QUEUE.Remove("building" + this._id, false, this);
            this._countdownFortify.Set(0);
            cost = this.FortifyCost();
            if (cost.r1.Get() > 0) BASE.Fund(1, Math.floor(cost.r1.Get()));
            if (cost.r2.Get() > 0) BASE.Fund(2, Math.floor(cost.r2.Get()));
            if (cost.r3.Get() > 0) BASE.Fund(3, Math.floor(cost.r3.Get()));
            if (cost.r4.Get() > 0) BASE.Fund(4, Math.floor(cost.r4.Get()));
            BASE.Save();
        }
    }

    public Upgrade(): boolean {
        let canUpgrade: any;
        if (!QUEUE.CanDo().error) {
            canUpgrade = BASE.CanUpgrade(this);
            if (!canUpgrade.error) {
                if (Math.floor(this._buildingProps.costs[this._lvl.Get()].time.Get() * GLOBAL._buildTime) > 3600) {
                    UPDATES.Create(["BU", this._id]);
                }
                this.UpgradeB();
                BASE.Save();
                return true;
            }
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(canUpgrade.errorMessage);
            }
        } else if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
            POPUPS.DisplayWorker(1, this);
        }
        return false;
    }

    public UpgradeB(): void {
        let GetFriends: Function;
        let canUpgrade: any;
        let o: any;
        let isInfernoBuilding: boolean = false;
        let tmpUpgradeTime: number = 0;
        let popupMC: any = null;

        if (this._countdownUpgrade.Get() == 0) {
            canUpgrade = BASE.CanUpgrade(this);
            if (!canUpgrade.error) {
                o = this.UpgradeCost();
                isInfernoBuilding = BASE.isInfernoBuilding(this._type);
                if (o.r1.Get() > 0) BASE.Charge(1, o.r1.Get(), false, isInfernoBuilding);
                if (o.r2.Get() > 0) BASE.Charge(2, o.r2.Get(), false, isInfernoBuilding);
                if (o.r3.Get() > 0) BASE.Charge(3, o.r3.Get(), false, isInfernoBuilding);
                if (o.r4.Get() > 0) BASE.Charge(4, o.r4.Get(), false, isInfernoBuilding);

                tmpUpgradeTime = Math.floor(this._buildingProps.costs[this._lvl.Get()].time.Get() * GLOBAL._buildTime);
                this._countdownUpgrade.Set(tmpUpgradeTime);

                if (this._type != 14 && this._countdownUpgrade.Get() > 60 * 60 * 2 && TUTORIAL._stage > 200) {
                    if (!GLOBAL._promptedInvite && BASE._credits.Get() < 40 && GLOBAL._canInvite && GLOBAL._friendCount == 0) {
                        GetFriends = (): void => {
                            if (BYMDevConfig.instance.USE_CLIENT_WITH_CALLBACK) {
                                GLOBAL.CallJSWithClient("cc.showFeedDialog", "callbackgift", ["invite"]);
                            } else {
                                GLOBAL.CallJS("cc.showFeedDialog", ["invite", "callbackgift"]);
                            }
                        };
                        GLOBAL._promptedInvite = true;
                        popupMC = new (window as any)["popup_helpme"]();
                        popupMC.tB.text = KEYS.Get("pop_helpme");
                        popupMC.bAction.SetupKey("btn_invitefriends");
                        popupMC.bAction.addEventListener(MouseEvent.CLICK, GetFriends);
                        POPUPS.Push(popupMC);
                    }
                }

                this._hasResources = false;
                this._hasWorker = false;
                if (GLOBAL._catchup) {
                    this._hasResources = true;
                    this._hasWorker = true;
                }
                QUEUE.Add("building" + this._id, this);
                LOGGER.Stat([7, this._type, this._lvl.Get() + 1]);
                this._helpList = [];
                this.Update();

                if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD && this._class == "tower") {
                    GLOBAL._selectedBuilding = this;
                    GLOBAL.Message(KEYS.Get("msg_inactiveupgrade"), KEYS.Get("btn_speedup"), STORE.SpeedUp, ["SP4"]);
                }
                GLOBAL.eventDispatcher.dispatchEvent(new BuildingEvent(BuildingEvent.UPGRADED, this));
            } else if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(canUpgrade.errorMessage);
            }
        }
    }

    public Help(): boolean {
        let i: number = 0;
        let timeRemoved: number = 0;
        let type: string = null;

        if (this._countdownBuild.Get() + this._countdownUpgrade.Get() + this._countdownFortify.Get() > 0) {
            if (this._helpList.length > 4) {
                GLOBAL.Message(KEYS.Get("base_5alreadyhelped"));
                return false;
            }
            for (let id of this._helpList) {
                if (id == LOGIN._playerID) {
                    GLOBAL.Message(KEYS.Get("base_alreadyhelped"));
                    return false;
                }
            }
            UPDATES.Create(["BH", this._id, LOGIN._playerID]);
            this._helpList.push(LOGIN._playerID);
            timeRemoved = this.HelpB();

            if (this._countdownBuild.Get() > 0) {
                GLOBAL.Message(KEYS.Get("base_thankbuild", {
                    "v1": GLOBAL.ToTime(timeRemoved, false, false),
                    "v2": KEYS.Get(this._buildingProps.name)
                }));
                LOGGER.Stat([14, this._type, 0, 0, timeRemoved]);
                type = "build";
            }
            if (this._countdownUpgrade.Get() > 0) {
                GLOBAL.Message(KEYS.Get("base_thankupgrade", {
                    "v1": GLOBAL.ToTime(timeRemoved, false, false),
                    "v2": KEYS.Get(this._buildingProps.name)
                }));
                LOGGER.Stat([15, this._type, this._lvl.Get() + 1, 0, timeRemoved]);
                type = "upgrade";
            }
            if (this._countdownFortify.Get() > 0) {
                GLOBAL.Message(KEYS.Get("base_thankfortify", {
                    "v1": GLOBAL.ToTime(timeRemoved, false, false),
                    "v2": KEYS.Get(this._buildingProps.name)
                }));
                LOGGER.Stat([66, this._type, this._fortification.Get() + 1, 0, timeRemoved]);
                type = "fortify";
            }
        }
        return true;
    }

    public HelpB(): number {
        let time: number = 0;
        if (this._countdownBuild.Get() > 0) {
            time = Math.floor(this._countdownBuild.Get() * 0.05);
            this._countdownBuild.Add(0 - Math.floor(this._countdownBuild.Get() * 0.05));
        } else if (this._countdownUpgrade.Get() > 0) {
            time = Math.floor(this._countdownUpgrade.Get() * 0.05);
            this._countdownUpgrade.Add(0 - Math.floor(this._countdownUpgrade.Get() * 0.05));
        } else if (this._countdownFortify.Get() > 0) {
            time = Math.floor(this._countdownFortify.Get() * 0.05);
            this._countdownFortify.Add(0 - Math.floor(this._countdownFortify.Get() * 0.05));
        }
        BASE.Save();
        return time;
    }

    public UpgradeCancel(): void {
        GLOBAL.Message(KEYS.Get("msg_upgradecancelconfirm"), KEYS.Get("msg_stopupgrading_btn"), this.UpgradeCancelB);
    }

    public UpgradeCancelB = (e: MouseEvent = null): void => {
        UPDATES.Create(["BUC", this._id]);
        this.UpgradeCancelC();
    }

    public UpgradeCancelC(): void {
        let cost: any = null;
        let isInferno: boolean = false;
        if (this._countdownUpgrade.Get() > 0) {
            QUEUE.Remove("building" + this._id, false, this);
            this._countdownUpgrade.Set(0);
            cost = this.UpgradeCost();
            isInferno = BASE.isInfernoBuilding(this._type);
            if (cost.r1.Get()) BASE.Fund(1, Math.floor(cost.r1.Get()), false, null, isInferno);
            if (cost.r2.Get()) BASE.Fund(2, Math.floor(cost.r2.Get()), false, null, isInferno);
            if (cost.r3.Get()) BASE.Fund(3, Math.floor(cost.r3.Get()), false, null, isInferno);
            if (cost.r4.Get()) BASE.Fund(4, Math.floor(cost.r4.Get()), false, null, isInferno);
            BASE.Save();
        }
    }

    public Upgraded(): void {
        let c: any;
        let a: number;
        try {
            if (Math.max(this._countdownUpgrade.Get(), 0)) {
                // Was likely logging logic here
            }
            this._countdownUpgrade.Set(0);
            this._lvl.Add(1);
            this._hpLvl++;
            this.maxHealthProperty.value = this._buildingProps.hp[this._lvl.Get() - 1];
            this.setHealth(this.maxHealth);
        } catch (e) {
            LOGGER.Log("err", "Foundation.Upgraded: " + e.message + " | " + e.getStackTrace());
        }
        QUESTS.Check("blvl", this._lvl.Get());
        if (this._type < 5) {
            QUESTS.Check("brlvl", this._lvl.Get());
        }
        QUESTS.Check("b" + this._type + "lvl", this._lvl.Get());
        BASE.CalcResources();
        c = this._buildingProps.costs[this._lvl.Get() - 2];
        a = Math.floor((Math.floor(c.time.Get()) + Math.floor(c.r1.Get()) + Math.floor(c.r2.Get()) + Math.floor(c.r3.Get()) + Math.floor(c.r4.Get())) / 3);
        BASE.PointsAdd(a);
        this.Description();
        QUEUE.Remove("building" + this._id, true, this);
        LOGGER.Stat([8, this._type, this._lvl.Get()]);
    }

    public downgraded(): void {
    }

    public Downgrade_TOTEM_DEBUG(): void {
        if (this._type != BTOTEM.BTOTEM_WMI2) return;
        if (this._lvl.Get() <= 1) return;
        try {
            this._countdownUpgrade.Set(0);
            this._lvl.Add(-1);
            this._hpLvl--;
            this.maxHealthProperty.value = this._buildingProps.hp[this._lvl.Get() - 1];
            this.setHealth(this.maxHealth);
        } catch (e) {
            LOGGER.Log("err", "Foundation.Downgrade_TOTEM_DEBUG: " + e.message + " | " + e.getStackTrace());
        }
    }

    public Fortified(): void {
        let c: any;
        let a: number;
        try {
            if (Math.max(this._countdownFortify.Get(), 0)) {
                LOGGER.Log("log", "bdg fort cnt > 0, probable hack");
                GLOBAL.ErrorMessage("BFOUNDATION fortify hack");
                return;
            }
            this._countdownFortify.Set(0);
            this._fortification.Add(1);
        } catch (e) {
            LOGGER.Log("err", "Foundation.Fortified: " + e.message + " | " + e.getStackTrace());
        }
        BASE.CalcResources();
        c = this._buildingProps.fortify_costs[this._fortification.Get() - 1];
        a = Math.floor((Math.floor(c.time.Get()) + Math.floor(c.r1.Get()) + Math.floor(c.r2.Get()) + Math.floor(c.r3.Get()) + Math.floor(c.r4.Get())) / 3);
        BASE.PointsAdd(a);
        this.Description();
        QUEUE.Remove("building" + this._id, true, this);
        LOGGER.Stat([65, this._type, this._fortification.Get()]);
    }

    public Recycle(): void {
        let msgKey: string = null;
        if (this._countdownBuild.Get() > 0) {
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                if (BASE.isOutpostOrInfernoOutpost) {
                    GLOBAL.Message(KEYS.Get("msg_stopconstructionoutpostbuilding"));
                } else {
                    GLOBAL.Message(KEYS.Get("msg_stopconstructionconfirm"), KEYS.Get("msg_destroybuilding_btn"), this.RecycleB);
                }
            }
        } else if (this._class == "taunt" || this._class == "gift") {
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(KEYS.Get("msg_recycleconfirm"), KEYS.Get("msg_recyclebuilding_btn"), this.RecycleC);
            }
        } else if (this._class == "decoration") {
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                GLOBAL.Message(KEYS.Get("ui_placeinstorage"), KEYS.Get("btn_addstorage"), this.RecycleB);
            }
        } else if (!this._blockRecycle) {
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                msgKey = GLOBAL._buildingProps[this._type - 1]["recycleconfirmationoverride"] ? String(GLOBAL._buildingProps[this._type - 1]["recycleconfirmationoverride"]) : "msg_recycleconfirm";
                GLOBAL.Message(KEYS.Get(msgKey), KEYS.Get("msg_recyclebuilding_btn"), this.RecycleB);
            }
        } else if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
            if (BASE.isOutpostOrInfernoOutpost) {
                GLOBAL.Message(KEYS.Get("msg_recycleoutpostbuilding"));
            } else {
                GLOBAL.Message(KEYS.Get("msg_recycleunavailable"));
            }
        }
        GLOBAL.eventDispatcher.dispatchEvent(new BuildingEvent(BuildingEvent.ATTEMPT_RECYCLE, this));
    }

    public RecycleB = (e: MouseEvent = null): void => {
        let cost: any = null;
        let isInferno: boolean = false;
        BUILDINGOPTIONS.Hide();
        if (this._class != "decoration" && !this._blockRecycle) {
            if (!this._recycled) {
                this._recycled = true;
                cost = this.RecycleCost();
                isInferno = BASE.isInfernoBuilding(this._type);
                if (cost.r1.Get()) BASE.Fund(1, Math.floor(cost.r1.Get()), false, null, isInferno);
                if (cost.r2.Get()) BASE.Fund(2, Math.floor(cost.r2.Get()), false, null, isInferno);
                if (cost.r3.Get()) BASE.Fund(3, Math.floor(cost.r3.Get()), false, null, isInferno);
                if (cost.r4.Get()) BASE.Fund(4, Math.floor(cost.r4.Get()), false, null, isInferno);
                this.RecycleC();
                LOGGER.Stat([40, this._type, this._lvl.Get()]);
            }
        } else if (!this._blockRecycle) {
            this.RecycleC();
        }
    }

    public RecycleC = (e: MouseEvent = null): void => {
        this.GridCost(false);
        try {
            if (MAP._BUILDINGFOOTPRINTS.contains(this._mcBase)) {
                MAP._BUILDINGBASES.removeChild(this._mcBase);
            }
        } catch (e) { }
        try {
            if (MAP._BUILDINGFOOTPRINTS.contains(this._mcFootprint)) {
                MAP._BUILDINGFOOTPRINTS.removeChild(this._mcFootprint);
            }
        } catch (e) { }
        try {
            if (MAP._BUILDINGTOPS.contains(this._mc)) {
                MAP._BUILDINGTOPS.removeChild(this._mc);
            }
        } catch (e) { }

        GRID.Clear();
        if (!BYMConfig.instance.RENDERER_ON) {
            MAP.SortDepth();
        }
        if (this._type != 7) {
            QUEUE.Remove("building" + this._id, false, this);
        }
        BASE.BuildingDeselect();
        if (this._class == "decoration") {
            InventoryManager.buildingStorageAdd(this._type, this._lvl.Get());
        }
        this.clear();
        BASE.Save();
    }

    public GridCost(block: boolean = true): void {
        let rect: any;
        if (this._footprint) {
            for (let item of this._footprint) {
                rect = item;
                GRID.Block(new Rectangle(rect.x + this._mc.x, rect.y + this._mc.y, rect.width, rect.height), block);
            }
        }
    }

    public RecycleCost(): any {
        let i: number = 0;
        let cost: any = null;
        let obj: any = {
            "r1": new SecNum(0),
            "r2": new SecNum(0),
            "r3": new SecNum(0),
            "r4": new SecNum(0),
            "r5": 0,
            "time": new SecNum(0)
        };
        if (GLOBAL._buildingProps[this._type - 1].rewarded) {
            return obj;
        }
        if (this._lvl.Get() == 0) {
            obj.r1.Add(this._buildingProps.costs[0].r1.Get());
            obj.r2.Add(this._buildingProps.costs[0].r2.Get());
            obj.r3.Add(this._buildingProps.costs[0].r3.Get());
            obj.r4.Add(this._buildingProps.costs[0].r4.Get());
            obj.r5 += this._buildingProps.costs[0].r5;
        } else {
            i = 0;
            while (i < this._lvl.Get()) {
                cost = this._buildingProps.costs[i];
                if (cost) {
                    obj.r1.Add(cost.r1.Get());
                    obj.r2.Add(cost.r2.Get());
                    obj.r3.Add(cost.r3.Get());
                    obj.r4.Add(cost.r4.Get());
                    obj.r5 += cost.r5;
                }
                i++;
            }
            obj.r1.Set(Math.floor(obj.r1.Get() * 0.5));
            obj.r2.Set(Math.floor(obj.r2.Get() * 0.5));
            obj.r3.Set(Math.floor(obj.r3.Get() * 0.5));
            obj.r4.Set(Math.floor(obj.r4.Get() * 0.5));
            obj.r5 = Math.floor(obj.r5 * 0.5);
        }
        return obj;
    }

    public UpgradeCost(): any {
        let obj: any = null;
        let cost: any = null;
        if (this._buildingProps.costs.length > this._lvl.Get()) {
            obj = {
                "time": new SecNum(0),
                "r1": new SecNum(this._buildingProps.costs[this._lvl.Get()].r1.Get()),
                "r2": new SecNum(this._buildingProps.costs[this._lvl.Get()].r2.Get()),
                "r3": new SecNum(this._buildingProps.costs[this._lvl.Get()].r3.Get()),
                "r4": new SecNum(this._buildingProps.costs[this._lvl.Get()].r4.Get()),
                "r1over": false,
                "r2over": false,
                "r3over": false,
                "r4over": false
            };
            cost = this._buildingProps.costs[this._lvl.Get()];
            if (BASE._resources.r1.Get() < cost.r1.Get()) obj.r1over = true;
            if (BASE._resources.r2.Get() < cost.r2.Get()) obj.r2over = true;
            if (BASE._resources.r3.Get() < cost.r3.Get()) obj.r3over = true;
            if (BASE._resources.r4.Get() < cost.r4.Get()) obj.r4over = true;
            obj.time.Set(cost.time.Get());
            return obj;
        }
        return {};
    }

    public FortifyCost(): any {
        let obj: any = null;
        let cost: any = null;
        if (this._buildingProps.can_fortify != true) {
            return {};
        }
        if (this._buildingProps.fortify_costs.length > this._fortification.Get()) {
            obj = {
                "time": new SecNum(0),
                "r1": new SecNum(this._buildingProps.fortify_costs[this._fortification.Get()].r1.Get()),
                "r2": new SecNum(this._buildingProps.fortify_costs[this._fortification.Get()].r2.Get()),
                "r3": new SecNum(this._buildingProps.fortify_costs[this._fortification.Get()].r3.Get()),
                "r4": new SecNum(this._buildingProps.fortify_costs[this._fortification.Get()].r4.Get()),
                "r1over": false,
                "r2over": false,
                "r3over": false,
                "r4over": false
            };
            cost = this._buildingProps.fortify_costs[this._fortification.Get()];
            if (BASE._resources.r1.Get() < cost.r1.Get()) obj.r1over = true;
            if (BASE._resources.r2.Get() < cost.r2.Get()) obj.r2over = true;
            if (BASE._resources.r3.Get() < cost.r3.Get()) obj.r3over = true;
            if (BASE._resources.r4.Get() < cost.r4.Get()) obj.r4over = true;
            obj.time.Set(cost.time.Get());
            return obj;
        }
        return {};
    }

    protected setupListeners(): void {
        if (!this._mcHit) return;
        if (!this._mcHit.hasEventListener(MouseEvent.MOUSE_DOWN)) this._mcHit.addEventListener(MouseEvent.MOUSE_DOWN, this.Mousedown);
        if (!this._mcHit.hasEventListener(MouseEvent.MOUSE_UP)) this._mcHit.addEventListener(MouseEvent.MOUSE_UP, this.Mouseup);
        if (!this._mcHit.hasEventListener(MouseEvent.MOUSE_OVER)) this._mcHit.addEventListener(MouseEvent.MOUSE_OVER, this.Over);
        if (!this._mcHit.hasEventListener(MouseEvent.MOUSE_OUT)) this._mcHit.addEventListener(MouseEvent.MOUSE_OUT, this.Out);
    }

    protected removeListeners(): void {
        if (!this._mcHit) return;
        if (this._mcHit.hasEventListener(MouseEvent.MOUSE_DOWN)) this._mcHit.removeEventListener(MouseEvent.MOUSE_DOWN, this.Mousedown);
        if (this._mcHit.hasEventListener(MouseEvent.MOUSE_UP)) this._mcHit.removeEventListener(MouseEvent.MOUSE_UP, this.Mouseup);
        if (this._mcHit.hasEventListener(MouseEvent.MOUSE_OVER)) this._mcHit.removeEventListener(MouseEvent.MOUSE_OVER, this.Over);
        if (this._mcHit.hasEventListener(MouseEvent.MOUSE_OUT)) this._mcHit.removeEventListener(MouseEvent.MOUSE_OUT, this.Out);
    }

    public Mousedown = (e: MouseEvent): void => {
        if (!this._placing) {
            MAP.Click();
            this._mouseClicked = true;
            if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD && UI2._showBottom) {
                this._clickTimer = 0;
            }
        }
    }

    public Mouseup = (e: MouseEvent): void => {
        if (this._mouseClicked) {
            this._mouseClicked = false;
            if (!MAP._dragged) {
                this.Click();
            }
        }
    }

    public StartMove(): void {
        try {
            BASE._blockSave = true;
            BASE.BuildingSelect(this, true);
            this.GridCost(false);
            this._moving = true;
            this._stopMoveCount = 0;
            this._mc.mouseEnabled = false;
            if (!PLANNER._open) {
                this._mc.addEventListener(Event.ENTER_FRAME, this.FollowMouseB);
                MAP._GROUND.addEventListener(MouseEvent.MOUSE_UP, this.StopMove);
                this._mcHit.mouseEnabled = false;
                BASE.ShowFootprints();
            }
            this._oldPosition = new Point(this._mc.x, this._mc.y);
            this._mouseOffset = new Point(MAP._GROUND.mouseX - this._mc.x, MAP._GROUND.mouseY - this._mc.y);
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.StartMove: " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.StartMove");
        }
    }

    public StopMove = (e: MouseEvent): void => {
        if (this._mouseClicked) {
            this._mouseClicked = false;
            if (!MAP._dragged) {
                MAP._GROUND.removeEventListener(MouseEvent.MOUSE_UP, this.StopMove);
                this._mc.mouseEnabled = true;
                this.StopMoveB();
            }
        }
        this._mouseClicked = true;
    }

    public StopMoveB(): void {
        try {
            if (this._moving) {
                this._moving = false;
                if (BASE.BuildBlockers(this, this._class == "decoration") != "") {
                    this._mc.x = this._oldPosition.x;
                    this._mc.y = this._oldPosition.y;
                    this._mcBase.x = this._mc.x;
                    this._mcBase.y = this._mc.y;
                    this._mcFootprint.x = this._mc.x;
                    this._mcFootprint.y = this._mc.y;
                    SOUNDS.Play("error1");
                } else {
                    SOUNDS.Play("buildingplace");
                }
                this._position = new Point(this._mc.x, this._mc.y);
                this._mc.mouseEnabled = false;
                this._mcHit.mouseEnabled = true;
                this._mc.removeEventListener(Event.ENTER_FRAME, this.FollowMouseB);
                this.GridCost(true);
                PATHING.ResetCosts();
                if (!BYMConfig.instance.RENDERER_ON) {
                    MAP.SortDepth();
                }
                BASE.BuildingDeselect();
                BASE.HideFootprints();
                BASE._blockSave = false;
                BASE.Save();
            }
        } catch (e) {
            LOGGER.Log("err", "BFOUNDATION.StartMove: " + e.getStackTrace());
            GLOBAL.ErrorMessage("BFOUNDATION.StartMove 2");
        }
        this.onMove();
    }

    public Click(e: MouseEvent = null): void {
        if (GLOBAL._openBase || TUTORIAL._stage >= 2 && TUTORIAL._stage != 90) {
            this.Description();
            if (!MAP._dragged) {
                if (GLOBAL.mode == GLOBAL.e_BASE_MODE.BUILD) {
                    BASE.BuildingSelect(this);
                }
                if (GLOBAL.mode == GLOBAL.e_BASE_MODE.HELP && this._countdownBuild.Get() + this._countdownUpgrade.Get() + this._countdownFortify.Get() > 0) {
                    BASE.BuildingSelect(this);
                }
                if (this._class == "taunt" || this._class == "gift") {
                    BASE.BuildingSelect(this);
                }
            }
        }
    }

    public Update(force: boolean = false): void {
        let msg: Array<any>;
        let total: number;
        let index: number;

        if (GLOBAL._render || force) {
            msg = [];
            if (this._repairing == 1) {
                total = 0;
                index = this._lvl.Get() == 0 ? 0 : Math.floor(this._lvl.Get() - 1);
                total = Math.ceil(this.maxHealth / Math.min(3600, this._buildingProps.repairTime[index]));
                this._repairTime = Math.floor(this.maxHealth - this.health) / total;
                QUEUE.Update("building" + this._id, KEYS.Get("ui_worker_stacktitle_repairing"), GLOBAL.ToTime(this._repairTime, true));
            } else if (this._countdownBuild.Get() > 0) {
                QUEUE.Update("building" + this._id, KEYS.Get("ui_worker_stacktitle_building"), GLOBAL.ToTime(this._countdownBuild.Get(), true));
            } else if (this._countdownUpgrade.Get() > 0) {
                QUEUE.Update("building" + this._id, KEYS.Get("ui_worker_stacktitle_upgrading"), GLOBAL.ToTime(this._countdownUpgrade.Get(), true));
            } else if (this._countdownFortify.Get() > 0) {
                QUEUE.Update("building" + this._id, KEYS.Get("ui_worker_stacktitle_fortifying"), GLOBAL.ToTime(this._countdownFortify.Get(), true));
            }

            if (this._class && this._class != "mushroom") {
                BuildingOverlay.Update(this, force);
            }
            if (this.health <= 0) {
                this.Render(BFOUNDATION.k_STATE_DESTROYED);
            } else if (this.isCriticallyDamaged) {
                this.Render(BFOUNDATION.k_STATE_DAMAGED);
            } else {
                this.Render(BFOUNDATION.k_STATE_DEFAULT);
            }
        }
    }

    public Constructed(): void {
        if (BASE.isOutpostOrInfernoOutpost) {
            this._blockRecycle = true;
        }
        this._countdownBuild.Set(0);
        this._constructed = true;
        if (!this._prefab && !BTOTEM.IsTotem2(this._type)) {
            this._lvl.Set(1);
            this._hpLvl = 1;
        } else {
            this._prefab = 0;
        }
        BASE.CalcResources();
        QUESTS.Check("blvl", this._lvl.Get());
        QUESTS.Check("b" + this._type + "lvl", this._lvl.Get());
        if (this._type < 5) {
            QUESTS.Check("brlvl", this._lvl.Get());
        }
        let cost: any = this._buildingProps.costs[0];
        let val: number = Math.floor(cost.time.Get() / 2 + (Math.floor(cost.r1.Get()) + Math.floor(cost.r2.Get()) + Math.floor(cost.r3.Get()) + Math.floor(cost.r4.Get())) / 10);
        if (this._type == 14) {
            val += 100;
        }
        BASE.PointsAdd(val);
        this.Description();
        QUEUE.Remove("building" + this._id, true, this);
        LOGGER.Stat([6, this._type]);
        this.Update();
    }

    public BlockClicks(): void {
        if (this._mcHit) {
            this._mcHit.mouseEnabled = false;
            this._mcHit.buttonMode = false;
        }
        if (this._mc) {
            this._mc.alpha = 0.5;
        }
    }

    public UnblockClicks(): void {
        if (this._mcHit) {
            this._mcHit.mouseEnabled = true;
            this._mcHit.buttonMode = true;
        }
        if (this._mc) {
            this._mc.alpha = 1;
        }
    }

    public exportLite(): any {
        let obj: any = new Object();
        let pos: Point = GRID.FromISO(this._mc.x, this._mc.y);
        obj.X = pos.x;
        obj.Y = pos.y;
        obj.id = this._id;
        obj.t = this._type;
        if (this._lvl.Get() != 1) {
            obj.l = this._lvl.Get();
        }
        if (this._countdownRebuild.Get() > 0) {
            obj.cR = this._countdownRebuild.Get();
        }
        if (this._repairing > 0) {
            obj.rE = this._repairing;
        }
        if (this.health < this.maxHealth) {
            obj.hp = Math.floor(this.health);
        }
        if (this._fortification.Get() > 0) {
            obj.fort = this._fortification.Get();
        }
        return obj;
    }

    public Export(): any {
        let obj: any = {};
        let pos: Point = GRID.FromISO(this._mc.x, this._mc.y);
        obj.X = pos.x;
        obj.Y = pos.y;
        obj.id = this._id;
        obj.t = this._type;

        if (this._lvl.Get() != 1) {
            obj.l = this._lvl.Get();
        }
        if (this._countdownBuild.Get() > 0) {
            obj.cB = this._countdownBuild.Get();
            if (this._prefab) {
                obj.prefab = this._prefab;
            }
        }
        if (this._countdownUpgrade.Get() > 0) {
            obj.cU = this._countdownUpgrade.Get();
        }
        if (this._countdownRebuild.Get() > 0) {
            obj.cR = this._countdownRebuild.Get();
        }
        if (this._countdownFortify.Get() > 0) {
            obj.cF = this._countdownFortify.Get();
        }
        if (this._repairing > 0) {
            obj.rE = this._repairing;
        }
        if (this._fortification.Get() > 0) {
            obj.fort = this._fortification.Get();
        }
        if (this._threadid) {
            obj.ti = this._threadid;
        }
        if (this._senderid) {
            obj.sid = this._senderid;
        }
        if (this._senderName) {
            obj.snm = this._senderName;
        }
        if (this._senderPic) {
            obj.spc = this._senderPic;
        }
        if (this._subject) {
            obj.sbj = this._subject;
        }
        if (this._productionStage.Get() > 0) {
            obj.rPS = this._productionStage.Get();
        }
        if (this._countdownProduce.Get() > 0) {
            obj.rCP = this._countdownProduce.Get();
        }
        if (this._inProduction != "") {
            obj.rIP = this._inProduction;
        }
        if (this.health < this.maxHealth && (!MapRoomManager.instance.isInMapRoom3 || BASE.isInfernoMainYardOrOutpost)) {
            obj.hp = Math.floor(this.health);
        }
        if (this._helpList.length > 0 && this._countdownBuild.Get() + this._countdownUpgrade.Get() + this._countdownFortify.Get() > 0) {
            obj.hl = this._helpList;
        }
        return obj;
    }

    public Setup(building: any): void {
        let pos: Point = null;
        let time: number = 0;
        let i: number = 0;
        let j: number = 0;
        let lvl: number = 0;
        let maxHP: number = 0;

        this._type = building.t;
        this._id = building.id;
        pos = GRID.ToISO(building.X, building.Y, 0);

        if (this._type == 112) {
            building.l = 1;
        }
        if (building.l && building.l <= Number.MAX_VALUE) {
            this._lvl.Set(Math.floor(building.l));
        } else {
            this._lvl.Set(1);
        }

        this._mc.x = pos.x;
        this._mc.y = pos.y;
        BASE._buildingCount++;
        this._countdownBuild.Set(Math.floor(building.cB));

        if (building.prefab) {
            this._prefab = building.prefab;
            this._lvl.Set(building.prefab);
            if (this._countdownBuild.Get() == 0) {
                time = 0;
                i = 0;
                while (i < building.prefab) {
                    time += GLOBAL._buildingProps[this._type - 1].costs[i].time.Get();
                    i++;
                }
                this._countdownBuild.Set(time);
            }
        }

        this._countdownUpgrade.Set(Math.floor(building.cU));
        this._countdownRebuild.Set(Math.floor(building.cR));
        this._hpCountdownRebuild = this._countdownRebuild.Get();

        if (building.fort) {
            this._fortification.Set(Math.min(building.fort, BYMConfig.k_sMAX_FORTIFICATION_LEVEL));
        } else {
            this._fortification.Set(0);
        }

        if (building.cF && this._fortification.Get() < BYMConfig.k_sMAX_FORTIFICATION_LEVEL) {
            this._countdownFortify.Set(Math.floor(building.cF));
        } else {
            this._countdownFortify.Set(0);
        }

        this._repairing = Math.floor(building.rE);
        if (this._repairing > 0) {
            this._repairing = 1;
        }

        this._productionStage.Set(Math.floor(building.rPS));
        this._countdownProduce.Set(Math.floor(building.rCP));
        this._hpCountdownProduce = this._countdownProduce.Get();

        if (building.rIP && building.rIP != "") {
            this._inProduction = building.rIP;
        }
        if (this._inProduction == "C100") {
            this._inProduction = "C12";
        }

        if (building.hl) this._helpList = building.hl;
        if (building.ti) this._threadid = building.ti;
        if (building.sid) this._senderid = building.sid;
        if (building.snm) this._senderName = building.snm;
        if (building.spc) this._senderPic = building.spc;
        if (building.sbj) this._subject = building.sbj;

        if (this._countdownBuild.Get() > 0 && !this._prefab) {
            this._lvl.Set(0);
        }
        this._hpLvl = this._lvl.Get();

        if (this._lvl.Get() == 0) {
            this.maxHealthProperty.value = this._buildingProps.hp[0];
        } else {
            lvl = this._lvl.Get();
            maxHP = Math.floor(this._buildingProps.hp[lvl - 1]);
            this.maxHealthProperty.value = maxHP;
        }

        if (building.hp == null) {
            this.setHealth(this.maxHealth);
        } else {
            this.setHealth(Math.floor(building.hp));
            if (this.health > this.maxHealth) {
                this.setHealth(this.maxHealth);
            }
        }

        if (this.health == 0) {
            this._destroyed = true;
            this._fired = true;
        }

        this.Description();
        this._constructed = this._countdownBuild.Get() == 0;
        if (this._lvl.Get() == 0 && this._constructed) {
            this._lvl.Set(1);
        }
        if (this._type == 17) {
            this._gridCost[1][1] = 100 + this._lvl.Get() * 25;
        }
        this.PlaceB();

        if (this._countdownBuild.Get() > 0) {
            if (this._prefab) {
                this._hasResources = true;
                this._hasWorker = true;
            } else if (QUEUE.Add("building" + this._id, this)) {
                this._hasResources = true;
            } else {
                this.RecycleC();
            }
        } else if (this._countdownUpgrade.Get() > 0) {
            if (QUEUE.Add("building" + this._id, this)) {
                this._hasResources = true;
            } else {
                this.UpgradeCancelB();
            }
        } else if (this._countdownFortify.Get() > 0) {
            if (QUEUE.Add("building" + this._id, this)) {
                this._hasResources = true;
            } else {
                this.FortifyCancelB();
            }
        } else {
            QUESTS.Check("blvl", this._lvl.Get());
            QUESTS.Check("b" + this._type + "lvl", this._lvl.Get());
            if (this._class == "resource") {
                QUESTS.Check("brlvl", this._lvl.Get());
            }
        }
    }

    public override clear(): void {
        if (this._type == 7) {
            delete BASE._buildingsMushrooms["m" + this._id];
        } else {
            delete BASE._buildingsAll["b" + this._id];
            delete BASE._buildingsWalls["b" + this._id];
            delete BASE._buildingsTowers["b" + this._id];
            delete BASE._buildingsMain["b" + this._id];
            delete BASE._buildingsGifts["b" + this._id];
        }

        if (this._mc.hasEventListener(Event.ENTER_FRAME)) {
            this._mc.removeEventListener(Event.ENTER_FRAME, this.FollowMouseB);
        }
        if (MAP._GROUND.hasEventListener(MouseEvent.MOUSE_UP)) {
            MAP._GROUND.removeEventListener(MouseEvent.MOUSE_UP, this.Place);
        }
        if (this._mc.hasEventListener(MouseEvent.MOUSE_DOWN)) {
            this._mc.removeEventListener(MouseEvent.MOUSE_DOWN, MAP.Click);
        }
        if (this._mc.hasEventListener(Event.ENTER_FRAME)) {
            this._mc.removeEventListener(Event.ENTER_FRAME, this.TickFast);
        }

        this.removeListeners();

        if (this._mcHit && this._mcHit.parent) {
            this._mcHit.parent.removeChild(this._mcHit);
        }
        if (this._mcFootprint && this._mcFootprint.parent) {
            this._mcFootprint.parent.removeChild(this._mcFootprint);
        }

        BuildingOverlay.clearBuilding(this);

        if (GLOBAL._selectedBuilding === this) {
            GLOBAL._selectedBuilding = null;
        }

        if (this._mcBase.parent) {
            this._mcBase.parent.removeChild(this._mcBase);
        }
        if (this._mc.parent) {
            this._mc.parent.removeChild(this._mc);
        }

        this.topContainer.Clear();
        this.animContainer.Clear();
        this._fortFrontContainer.Clear();
        this._fortBackContainer.Clear();
        this.anim2Container.Clear();
        this.anim3Container.Clear();

        if (this._animContainerBMD) {
            this._animContainerBMD.dispose();
        }
        if (this._anim2ContainerBMD) {
            this._anim2ContainerBMD.dispose();
        }
        if (this._anim3ContainerBMD) {
            this._anim3ContainerBMD.dispose();
        }

        this.clearRasterData();
        this._rasterData = null;
        this._rasterPt = null;
        InstanceManager.removeInstance(this);
        this.m_shadowBMD = null;
        super.clear();
    }

    private GetHitMC(): MovieClip {
        let props: any = GLOBAL._buildingProps[this._type - 1] ? GLOBAL._buildingProps[this._type - 1] : {};
        if (props.hitCls) {
            return new props.hitCls();
        }
        let isInferno: boolean = BASE.isInfernoMainYardOrOutpost;

        // Dynamic instantiation helper
        const create = (name: string) => { return new (window as any)[name](); };

        if (this._type == 1) return isInferno ? create("boneCrusherHit") : create("building1hit");
        if (this._type == 2) return isInferno ? create("coalProducerHit") : create("building2hit");
        if (this._type == 3) return isInferno ? create("sulpherProducerHit") : create("building3hit");
        if (this._type == 4) return isInferno ? create("magmaProducerHit") : create("building4hit");
        if (this._type == 5) return create("building5hit");
        if (this._type == 6) return isInferno ? create("siloHit") : create("building6hit");
        if (this._type == 7) return create("building7hit");
        if (this._type == 8) return isInferno ? create("monsterLockerHit") : create("building8hit");
        if (this._type == 9) return create("building9hit");
        if (this._type == 10) return create("building10hit");
        if (this._type == 11) return create("building11hit");
        if (this._type == 12) return create("building12hit");
        if (this._type == 13) return isInferno ? create("hatcheryHit") : create("building13hit");
        if (this._type == 14) return isInferno ? create("townHallHit") : create("building14hit");
        if (this._type == 15) return create("building15hit");
        if (this._type == 16) return create("building16hit");
        if (this._type == 17) return isInferno ? create("wallHit") : create("building17hit");
        if (this._type == 18) return create("building18hit");
        if (this._type == 19) return create("building19hit");
        if (this._type == 20) return isInferno ? create("cannonTowerHit") : create("building20hit");
        if (this._type == 21) return isInferno ? create("sniperTowerHit") : create("building21hit");
        if (this._type == 22) return create("building22hit");
        if (this._type == 23) return create("building23hit");
        if (this._type == 24) return create("building24hit");
        if (this._type == 25) return create("building25hit");
        if (this._type == 26) return isInferno ? create("infernoAcademyHit") : create("building26hit");
        if (this._type == 27) return create("building27hit");
        if (this._type == 51) return create("building51hit");
        if (this._type == 53) return create("building53hit");
        if (this._type == 54) return create("building54hit");
        if (this._type == 55) return create("building55hit");
        if (this._type >= 28 && this._type <= 50) return create("buildingflaghit");
        if (this._type == 56) return create("building56hit");
        if (this._type == 57) return create("building57hit");
        if (this._type >= 60 && this._type <= 62) return create("buildinggnomehit");
        if (this._type == 63) return create("building63hit");
        if (this._type == 64) return create("building64hit");
        if (this._type == 65) return create("building65hit");
        if (this._type == 66) return create("building66hit");
        if (this._type == 68) return create("building68hit");
        if (this._type == 71) return create("building71hit");
        if (this._type == 72) return create("building72hit");
        if (this._type == 73) return create("building73hit");
        if (this._type >= 74 && this._type <= 85 || this._type == 107) return create("buildingheadhit");
        if (this._type == 86) return create("building86hit");
        if (this._type == 87) return create("building87hit");
        if (this._type == 88) return create("building88hit");
        if (this._type == 89) return create("building89hit");
        if (this._type == 90) return create("building90hit");
        if (this._type >= 91 && this._type <= 95) return create("buildingflowershit");
        if (this._type == 96) return create("building96hit");
        if (this._type == 97) return create("building97hit");
        if (this._type == 98) return create("building98hit");
        if (this._type == 99) return create("building99hit");
        if (this._type == 100) return create("building100hit");
        if (this._type == 101) return create("building101hit");
        if (this._type == 102) return create("building102hit");
        if (this._type == 103) return create("building103hit");
        if (this._type == 104) return create("building104hit");
        if (this._type == 105) return create("building105hit");
        if (this._type == 106) return create("building106hit");
        if (this._type >= 108 && this._type <= 109) return create("buildingcubehit");
        if (this._type == 106) return create("building106hit");
        if (this._type == 110) return create("building110hit");
        if (this._type == 111) return create("building111hit");
        if (this._type == 112) return create("building112hit");
        if (this._type == 113) return create("building113hit");
        if (this._type == 114) return create("building114hit");
        if (this._type == 115) return create("building115hit");
        if (this._type == 116) return create("building116hit");
        if (this._type == 117) return create("building117hit");
        if (this._type == 118) return create("building118hit");
        if (this._type == 119) return create("building119hit");
        if (this._type == 120) return create("building120hit");
        if (this._type == 121) return create("building121hit");
        if (this._type == 122) return create("building122hit");
        if (this._type == 123) return create("building123hit");
        if (this._type == 124) return create("building124hit");
        if (this._type == 125) return create("building125hit");
        if (this._type == 126) return create("building126hit");
        if (this._type == 127) return create("infernoPortalHit");
        if (this._type == 128) return create("housingBunkerHit");
        if (this._type == 129) return create("quakeTowerHit");
        if (this._type == 130) return create("cannonTowerHit");
        if (this._type == 131) return create("building131hit");
        if (this._type == 132) return create("magmaTowerHit");
        if (this._type == 135) return create("building135hit");

        return props.hitCls ? new props.hitCls() : create("building1hit");
    }

    private GetFootprintMC(): MovieClip {
        const create = (name: string) => { return new (window as any)[name](); };
        
        if (this._footprint[0].width == 20) return create("buildingFootprint20x20");
        if (this._footprint[0].width == 30) return create("buildingFootprint30x30");
        if (this._footprint[0].width == 40) return create("buildingFootprint40x40");
        if (this._footprint[0].width == 70) return create("buildingFootprint70x70");
        if (this._footprint[0].width == 80) return create("buildingFootprint80x80");
        if (this._footprint[0].width == 90) return create("buildingFootprint90x90");
        if (this._footprint[0].width == 100) return create("buildingFootprint100x100");
        if (this._footprint[0].width == 130) return create("buildingFootprint130x130");
        if (this._footprint[0].width == 160) return create("buildingFootprint160x160");
        if (this._footprint[0].width == 190) return create("buildingFootprint190x160");
        
        return new MovieClip();
    }

    public highlight(param1: number): void {
        let arr: Array<number>;
        if (this._mc) {
            arr = new Array();
            arr = arr.concat([2, 0, 0, 0, 0]);
            arr = arr.concat([0, 2, 0, 0, 0]);
            arr = arr.concat([0, 0, 3, 0, 0]);
            arr = arr.concat([0, 0, 0, 1, 0]);
            this._mc.filters = [new ColorMatrixFilter(arr)];
            if (BYMConfig.instance.RENDERER_ON && this._rasterData[BFOUNDATION._RASTERDATA_TOP]) {
                this._rasterData[BFOUNDATION._RASTERDATA_TOP].filter = this._mc.filters[0];
            }
        }
    }

    public disableHighlight(): void {
        if (this._mc) {
            this._mc.filters = [];
            if (BYMConfig.instance.RENDERER_ON && this._rasterData[BFOUNDATION._RASTERDATA_TOP]) {
                this._rasterData[BFOUNDATION._RASTERDATA_TOP].filter = null;
            }
        }
    }

    public set x(value: number) {
        this._mc.x = value;
        this.onMove();
        this.updateRasterData();
    }

    // Need to define getter for x to override setter properly in some TS configurations
    public get x(): number {
        return this._mc.x;
    }

    public set y(value: number) {
        this._mc.y = value;
        this.onMove();
        this.updateRasterData();
    }

    public get y(): number {
        return this._mc.y;
    }

    public moveTo(x: number, y: number): void {
        this.GridCost(false);
        this.x = x;
        this.y = y;
        (this._mcBase as MovieClip).x = x;
        (this._mcBase as MovieClip).y = y;
        this._mcFootprint.x = x;
        this._mcFootprint.y = y;
        this.StartMove();
        this.StopMove(null);
        this.updateRasterData();
        BFOUNDATION.redrawAllShadowData();
    }

    protected onMove(): void {
    }

    public get name(): string {
        return KEYS.Get(this._buildingProps.name);
    }

    public get isUpgrading(): boolean {
        return this._countdownUpgrade.Get() > 0;
    }

    public get isBuilding(): boolean {
        return this._countdownBuild.Get() > 0;
    }

    protected RelocateHousedCreatures(): void {
        let monster: MonsterBase;
        let building: BFOUNDATION = BASE.FindClosestHousingToPoint(this.x, this.y, this);
        if (building == null) {
            return;
        }
        let len: number = this._creatures.length;
        let i: number = 0;
        while (i < len) {
            monster = this._creatures[i];
            if (monster._behaviour != MonsterBase.k_sBHVR_JUICE) {
                building._creatures.push(monster);
                monster._house = building;
                monster._targetCenter = GRID.FromISO(building.x, building.y);
                monster.changeModeHousing();
            }
            i++;
        }
        this._creatures.length = 0;
    }

    protected UpdateHousedCreatureTargets(): void {
        let monster: MonsterBase;
        let len: number = this._creatures.length;
        let i: number = 0;
        while (i < len) {
            monster = this._creatures[i];
            if (!(monster._behaviour == MonsterBase.k_sBHVR_JUICE || monster._behaviour == MonsterBase.k_sBHVR_BUNKER && GLOBAL.InfernoMode() === false)) {
                monster._targetCenter = GRID.FromISO(this.x, this.y);
                monster.changeModeHousing();
            }
            i++;
        }
    }

    public StartProduction(): void {
    }

    protected onEnterFrame(event: Event): void {
    }

    protected removedFromStage(event: Event): void {
        this.graphic.removeEventListener(Event.ENTER_FRAME, this.onEnterFrame);
        this.graphic.removeEventListener(Event.REMOVED_FROM_STAGE, this.removedFromStage);
    }
}
